<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>TANGERINE - Premium Shop</title>
<meta name="description" content="TANGERINE - Shop Premium WPFF, Double Static & Fresh Frozen">
<meta name="theme-color" content="#1e293b">
<meta name="color-scheme" content="dark">

<!-- OPTIMISATION #3: Telegram WebApp SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  // Init Telegram d√®s que possible
  if (window.Telegram?.WebApp) {
    try {
      window.Telegram.WebApp.ready();
      window.Telegram.WebApp.expand();
      console.log('‚úÖ Telegram WebApp ready');
    } catch(e) {
      console.error('Telegram init error:', e);
    }
  }

  // D√©sactiver Umami pour le compte propri√©taire (@Tangerine_212)
  (function disableUmamiForOwner() {
    const disable = () => {
      try {
        const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user;
        if (tgUser?.username && tgUser.username.toLowerCase() === 'tangerine_212') {
          localStorage.setItem('umami.disabled', '1');
          console.log('üìä Umami tracking disabled for owner session');
          return true;
        }
      } catch (error) {
        console.warn('Umami owner check failed', error);
      }
      return false;
    };

    if (!disable()) {
      setTimeout(disable, 800); // Retry apr√®s init √©ventuelle du WebApp
    }
  })();
</script>

<!-- OPTIMISATION #4: Lazy load analytics apr√®s 3s pour ne pas ralentir le chargement initial -->
<script>
  // Charger les analytics apr√®s que l'utilisateur ait interagi avec le site
  window.addEventListener('load', function() {
    setTimeout(function() {
      // Umami Analytics
      var umami = document.createElement('script');
      umami.defer = true;
      umami.src = 'https://cloud.umami.is/script.js';
      umami.setAttribute('data-website-id', '75e01154-ec06-4bdf-bc72-4b7fb1157e5b');
      document.head.appendChild(umami);

      // Microsoft Clarity
      (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "u2rza6fjql");
      
      console.log('üìä Analytics loaded');
    }, 3000); // Charger apr√®s 3 secondes
  });
</script>

<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<!-- Improve connection for third-party media hosts to speed up video loads -->
<link rel="preconnect" href="https://files.catbox.moe" crossorigin>
<link rel="preconnect" href="https://file.garden" crossorigin>
<!-- Preload the Tropicali example videos to reduce first-play delay -->
<link rel="preload" as="video" href="https://files.catbox.moe/p7wuqu.mp4" type="video/mp4">
<link rel="preload" as="video" href="https://file.garden/aRCOOh-cGER2BR_t/copy_A0E9A19D-D622-46CF-B7FC-ACC032A9499F%20(1).mp4" type="video/mp4">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<style>
  * { font-family: 'Poppins', system-ui, sans-serif; margin: 0; padding: 0; box-sizing: border-box; }
  
  /* Force dark mode - prevent system theme from affecting the site */
  html, body {
    color-scheme: dark !important;
    background-color: #0f172a !important;
    overflow-x: hidden;
    -webkit-tap-highlight-color: transparent;
  }
  
  .snap-x { 
    scroll-snap-type: x mandatory;
    scrollbar-width: none;
    -ms-overflow-style: none;
    -webkit-overflow-scrolling: touch;
  }
  .snap-x::-webkit-scrollbar { display: none; }
  .snap-center { scroll-snap-align: center; }
  
  @keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
  @keyframes slideInRight{from{opacity:0;transform:translateX(50px)}to{opacity:1;transform:translateX(0)}}
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
  @keyframes shimmer{0%{background-position:-1000px 0}100%{background-position:1000px 0}}
  @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-15px)}}
  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes slideUp{from{transform:translateY(100%);opacity:0}to{transform:translateY(0);opacity:1}}
  @keyframes zoomIn{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
  @keyframes progressBar{from{width:0}to{width:100%}}
  @keyframes confetti{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}
  @keyframes slideDown{from{transform:translateY(-100%);opacity:0}to{transform:translateY(0);opacity:1}}
  @keyframes scaleIn{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
  
  .animate-fade-in-up{animation:fadeInUp .4s ease-out forwards}
  .animate-slide-in-right{animation:slideInRight .4s ease-out forwards}
  .animate-pulse{animation:pulse 2s ease-in-out infinite}
  .animate-slide-up{animation:slideUp .3s ease-out forwards}
  .animate-zoom-in{animation:zoomIn .25s ease-out forwards}
  .animate-slide-down{animation:slideDown .3s ease-out forwards}
  .animate-scale-in{animation:scaleIn .2s ease-out forwards}
  .float{animation:float 2.5s ease-in-out infinite}
  .spinner{animation:spin .8s linear infinite}
  
  .confetti {
    position: fixed;
    width: 10px;
    height: 10px;
    background: #f97316;
    animation: confetti 3s linear forwards;
    pointer-events: none;
    z-index: 9999;
  }
  
  .shimmer {
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
  }
  
  .glass {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
  }
  
  .glass-dark {
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
  }
  
  .gradient-text {
    background: linear-gradient(135deg, #f97316, #facc15, #22c55e);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .glow {
    box-shadow: 0 0 36px rgba(249, 115, 22, 0.45);
  }
  
  .glow-pink {
    box-shadow: 0 0 30px rgba(236, 72, 153, 0.5);
  }
  
  .card-hover {
    position: relative;
    z-index: 0;
    transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .card-hover:hover {
    transform: translateY(-6px) scale(1.015);
  }

  .card-hover:active {
    transform: translateY(-2px) scale(0.995);
  }

  .quantity-button {
    position: relative;
    overflow: hidden;
    transition: transform 0.22s ease;
  }

  .quantity-button::after {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.35), transparent 65%);
    opacity: 0;
    transform: scale(0.55);
    transition: opacity 0.35s ease, transform 0.35s ease;
    pointer-events: none;
  }

  .quantity-button.tap-state {
    animation: quantityBounce 0.32s ease;
  }

  .quantity-button.tap-state::after,
  .quantity-button:active::after {
    opacity: 1;
    transform: scale(1.3);
  }

  @keyframes quantityBounce {
    0% { transform: scale(1); }
    40% { transform: scale(0.9); }
    70% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }

  .card-halo {
    position: absolute;
    inset: -14px;
    border-radius: 32px;
    pointer-events: none;
    opacity: 0;
    background: radial-gradient(circle at 35% 35%, rgba(249, 115, 22, 0.24), transparent 60%),
                radial-gradient(circle at 70% 70%, rgba(34, 197, 94, 0.2), transparent 66%);
    filter: blur(22px);
    transform: scale(1.03);
    transition: opacity 0.4s ease;
    z-index: -1;
  }

  .card-playing .card-halo {
    opacity: 0.32;
  }

  .category-progress {
    position: relative;
    height: 3px;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.08);
    overflow: hidden;
    margin-top: 0.5rem;
  }

  .category-progress .category-progress-bar {
    position: absolute;
    inset: 0;
    transform-origin: left center;
    transform: scaleX(0);
    background: linear-gradient(90deg, rgba(249, 115, 22, 0.9), rgba(34, 197, 94, 0.85));
    box-shadow: 0 0 14px rgba(249, 115, 22, 0.4);
    transition: transform 0.2s ease-out;
  }

  .scroll-smooth { scroll-behavior: smooth; }
  
  button:focus-visible, a:focus-visible {
    outline: 2px solid #f97316;
    outline-offset: 2px;
  }
  
  .skeleton {
    background: linear-gradient(90deg, rgba(255,255,255,0.03) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.03) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
  }
  
  .skeleton-card {
    background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 1.5rem;
    min-height: 400px;
  }
  
  .search-highlight {
    background: linear-gradient(135deg, rgba(249, 115, 22, 0.3), rgba(236, 72, 153, 0.3));
    padding: 0 2px;
    border-radius: 2px;
  }
  
  .thumbnail-blur {
    filter: blur(10px);
    transform: scale(1.1);
  }
  
  .video-loaded {
    filter: blur(0);
    transform: scale(1);
    transition: all 0.3s ease-out;
  }

  /* Hide scrollbar but keep functionality */
  .hide-scrollbar {
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE and Edge */
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
  }
  .hide-scrollbar::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Opera */
  }

  /* Smooth transition for videos when swapping / loading */
  .video-smooth {
    transition: opacity 0.28s ease, transform 0.28s ease;
    will-change: opacity, transform;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
  }
  
  /* Aurora background layers */
  .background-aurora {
    position: absolute;
    inset: 0;
    overflow: hidden;
    pointer-events: none;
    z-index: 0;
  }

  .aurora-blob {
    position: absolute;
    width: 70vmax;
    height: 70vmax;
    border-radius: 50%;
    filter: blur(140px);
    opacity: 0.5;
    animation: auroraDrift 32s ease-in-out infinite alternate;
    mix-blend-mode: screen;
  }

  .aurora-blob-1 {
    top: -24vmax;
    left: -18vmax;
    background: radial-gradient(circle at 30% 30%, rgba(34, 197, 94, 0.55), rgba(34, 197, 94, 0));
    animation-delay: 0s;
  }

  .aurora-blob-2 {
    top: 16vmax;
    right: -22vmax;
    background: radial-gradient(circle at 70% 40%, rgba(251, 191, 36, 0.55), rgba(251, 191, 36, 0));
    animation-delay: 6s;
  }

  .aurora-blob-3 {
    bottom: -26vmax;
    left: 22vmax;
    background: radial-gradient(circle at 50% 50%, rgba(56, 189, 248, 0.45), rgba(56, 189, 248, 0));
    animation-delay: 12s;
  }

  .theme-light .aurora-blob {
    opacity: 0.28;
    mix-blend-mode: multiply;
  }

  .theme-light .aurora-blob-1 {
    background: radial-gradient(circle at 30% 30%, rgba(190, 242, 100, 0.32), rgba(190, 242, 100, 0));
  }

  .theme-light .aurora-blob-2 {
    background: radial-gradient(circle at 70% 40%, rgba(254, 243, 199, 0.28), rgba(254, 243, 199, 0));
  }

  .theme-light .aurora-blob-3 {
    background: radial-gradient(circle at 50% 50%, rgba(168, 218, 220, 0.28), rgba(168, 218, 220, 0));
  }

  .noise-overlay {
    position: absolute;
    inset: 0;
    background-image: url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64"%3E%3Cfilter id="n" x="0" y="0" width="1" height="1"%3E%3CfeTurbulence baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/%3E%3C/filter%3E%3Crect width="64" height="64" filter="url(%23n)" opacity="0.3"/%3E%3C/svg%3E');
    opacity: 0.16;
    mix-blend-mode: soft-light;
    pointer-events: none;
    z-index: 1;
  }

  .theme-light .noise-overlay {
    opacity: 0.09;
    mix-blend-mode: multiply;
  }

  @keyframes auroraDrift {
    0% {
      transform: translate3d(0, 0, 0) scale(1);
    }
    50% {
      transform: translate3d(6%, -8%, 0) scale(1.08);
    }
    100% {
      transform: translate3d(-5%, 9%, 0) scale(0.97);
    }
  }

  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
  
  /* Theme toggle button styles */
  .theme-toggle {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 45;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }
  
  /* Hide toggle when cart drawer is open */
  .theme-toggle.cart-open {
    opacity: 0;
    pointer-events: none;
    transform: scale(0.8);
  }
  
  .theme-light .theme-toggle {
    background: rgba(255, 255, 255, 0.7);
    border-color: rgba(0, 0, 0, 0.1);
    color: #1e293b;
  }
  
  .theme-toggle:hover {
    transform: scale(1.1);
    background: rgba(0, 0, 0, 0.6);
  }
  
  .theme-light .theme-toggle:hover {
    background: rgba(255, 255, 255, 0.9);
  }
  
  .theme-toggle:active {
    transform: scale(0.95);
  }
  
  .theme-toggle svg {
    width: 20px;
    height: 20px;
    fill: currentColor;
  }

  .welcome-toast {
    position: fixed;
    top: calc(1.25rem + env(safe-area-inset-top, 0px));
    left: 50%;
    transform: translate(-50%, -16px) scale(0.9);
    background: linear-gradient(135deg, rgba(249, 115, 22, 0.75), rgba(34, 197, 94, 0.75));
    border: 1px solid rgba(255, 255, 255, 0.16);
    box-shadow: 0 20px 45px -25px rgba(249, 115, 22, 0.65);
    border-radius: 999px;
    padding: 0.75rem 1.6rem;
    color: #0b1120;
    z-index: 70;
    opacity: 0;
    pointer-events: none;
    display: flex;
    align-items: center;
    gap: 0.7rem;
    transition: opacity 0.32s ease, transform 0.32s cubic-bezier(0.22, 1, 0.36, 1);
    backdrop-filter: blur(18px);
  }

  .welcome-toast::after {
    content: '';
    position: absolute;
    inset: -60% auto auto -45%;
    width: 160px;
    height: 160px;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.2), transparent 65%);
    filter: blur(20px);
    z-index: -1;
  }

  .welcome-toast .welcome-text {
    font-size: 1.15rem;
    font-weight: 800;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    animation: welcomePulse 2.4s ease-in-out infinite;
  }

  .welcome-toast.show {
    opacity: 1;
    transform: translate(-50%, 0) scale(1);
    pointer-events: auto;
  }

  @keyframes welcomePulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    45% { transform: scale(1.04); opacity: 0.92; }
    65% { transform: scale(0.98); opacity: 1; }
  }

  /* Light theme styles - Enhanced day mode palette */
  .theme-light {
    --bg-primary: #f8fafc;
    --bg-secondary: #f1f5f9;
    --text-primary: #0f172a;
    --text-secondary: #475569;
    --text-tertiary: #64748b;
    --glass-bg: rgba(255, 255, 255, 0.85);
    --glass-border: rgba(148, 163, 184, 0.2);
    --glass-dark-bg: rgba(255, 255, 255, 0.95);
    --glass-dark-border: rgba(148, 163, 184, 0.3);
    --shadow-color: rgba(15, 23, 42, 0.1);
  }
  
  .theme-light body {
    background-color: var(--bg-primary) !important;
  }
  
  .theme-light .glass {
    background: var(--glass-bg) !important;
    border-color: var(--glass-border) !important;
    box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -1px var(--shadow-color);
  }
  
  .theme-light .glass-dark {
    background: var(--glass-dark-bg) !important;
    border-color: var(--glass-dark-border) !important;
    box-shadow: 0 10px 15px -3px var(--shadow-color), 0 4px 6px -2px var(--shadow-color);
  }
  
  /* Light theme text colors */
  .theme-light .text-white {
    color: var(--text-primary) !important;
  }
  
  .theme-light .text-white\/60,
  .theme-light .text-white\/70,
  .theme-light .text-white\/80 {
    color: var(--text-secondary) !important;
  }
  
  .theme-light .text-white\/40 {
    color: var(--text-tertiary) !important;
  }
  
  /* Light theme specific adjustments for better contrast */
  .theme-light .gradient-text {
    background: linear-gradient(135deg, #fdba74, #fde68a, #bbf7d0);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .theme-light .glow {
    box-shadow: 0 0 30px rgba(249, 115, 22, 0.4);
  }
  
  .theme-light .glow-pink {
    box-shadow: 0 0 30px rgba(236, 72, 153, 0.3);
  }
  
  /* Light theme button and interactive element adjustments */
  .theme-light button.text-white,
  .theme-light .text-white {
    color: var(--text-primary) !important;
  }
  
  .theme-light .bg-black\/30 {
    background-color: rgba(241, 245, 249, 0.5) !important;
  }
  
  .theme-light .bg-black\/20 {
    background-color: rgba(241, 245, 249, 0.3) !important;
  }
  
  .theme-light .bg-black\/50 {
    background-color: rgba(241, 245, 249, 0.7) !important;
  }
  
  .theme-light .bg-black\/70 {
    background-color: rgba(241, 245, 249, 0.85) !important;
  }
  
  .theme-light .bg-black\/80 {
    background-color: rgba(241, 245, 249, 0.9) !important;
  }
  
  /* Light theme border adjustments */
  .theme-light .border-white\/10 {
    border-color: rgba(148, 163, 184, 0.2) !important;
  }
  
  .theme-light .border-white\/20 {
    border-color: rgba(148, 163, 184, 0.3) !important;
  }
  
  /* Light theme backdrop blur text readability */
  .theme-light .backdrop-blur-sm {
    background-color: rgba(255, 255, 255, 0.8) !important;
  }

  /* Low data / reduced visuals mode: disable heavy blurs and particle-like effects */
  .low-data .glass,
  .low-data .glass-dark {
    backdrop-filter: none !important;
    background: rgba(255,255,255,0.02) !important;
    border-color: rgba(255,255,255,0.03) !important;
  }

  .low-data .confetti { display: none; }
  .low-data .spinner { display: none; }
  
  /* Telegram header spacing - works in both full-screen and partial-screen modes */
  .telegram-header {
    padding-top: 4rem;
  }
  
  /* Additional spacing for Telegram full-screen mode */
  @supports (padding: env(safe-area-inset-top)) {
    .telegram-header {
      padding-top: max(4rem, calc(4rem + env(safe-area-inset-top)));
    }
  }
  
  /* Fallback for browsers that don't support env() */
  @media (max-width: 768px) {
    .telegram-header {
      padding-top: 5rem;
    }
  }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useMemo, useCallback } = React;

// Central video loading and caching manager
class VideoManager {
  constructor(maxConcurrent = 3) {
    this.maxConcurrent = maxConcurrent;
    this.loading = new Set();
    this.cache = new Map();
    this.queue = [];
    this.isIosTelegram = this.detectIosTelegram();
  }

  detectIosTelegram() {
    try {
      if (window.Telegram?.WebApp?.platform) {
        return window.Telegram.WebApp.platform.toLowerCase() === 'ios';
      }
    } catch (e) {}
    return /iphone|ipad|ipod/i.test(navigator.userAgent || '');
  }

  async loadVideo(src, options = {}) {
    // Return cached result if available and valid
    if (this.cache.has(src)) {
      const cached = this.cache.get(src);
      if (cached.blob && !cached.error) {
        return cached.blob;
      }
    }

    // Queue if too many concurrent loads
    if (this.loading.size >= this.maxConcurrent) {
      await new Promise(resolve => this.queue.push(resolve));
    }

    // Start loading
    this.loading.add(src);
    try {
      const response = await fetch(src);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const blob = await response.blob();
      const objectUrl = URL.createObjectURL(blob);
      this.cache.set(src, { blob: objectUrl, error: null });
      return objectUrl;
    } catch (error) {
      this.cache.set(src, { blob: null, error });
      throw error;
    } finally {
      this.loading.delete(src);
      if (this.queue.length > 0) {
        const next = this.queue.shift();
        next();
      }
    }
  }

  preloadVideo(src) {
    if (this.cache.has(src)) return;
    this.loadVideo(src).catch(() => {}); // Silently fail preloads
  }

  // Prepare a video element for instant playback
  async prepareVideo(videoElement, src, options = {}) {
    try {
      // Force essential mobile attributes
      videoElement.playsInline = true;
      videoElement.muted = true;
      videoElement.setAttribute('playsinline', '');
      videoElement.setAttribute('muted', '');
      videoElement.setAttribute('webkit-playsinline', '');
      videoElement.defaultMuted = true;

      const useDirectSrc = options?.forceDirectSrc || this.isIosTelegram;
      if (useDirectSrc) {
        videoElement.src = src;
      } else {
        // Try to load from cache or fetch
        const objectUrl = await this.loadVideo(src);
        videoElement.src = objectUrl;
      }

      // Pr√©charger les donn√©es vid√©o sans lancer la lecture
      return new Promise((resolve, reject) => {
        const cleanup = () => {
          videoElement.removeEventListener('loadeddata', onLoaded);
          videoElement.removeEventListener('error', onError);
        };

        const onLoaded = () => {
          cleanup();
          resolve();
        };

        const onError = (event) => {
          cleanup();
          reject(event?.error || new Error('video_load_error'));
        };

        try {
          videoElement.preload = 'auto';
          videoElement.currentTime = 0;
          videoElement.addEventListener('loadeddata', onLoaded, { once: true });
          videoElement.addEventListener('error', onError, { once: true });
          videoElement.load();
        } catch (e) {
          cleanup();
          reject(e);
        }
      });
    } catch (error) {
      console.warn('Video prepare failed:', error);
      throw error;
    }
  }
}

// Global video manager instance
window.videoManager = window.videoManager || new VideoManager(3);

// Preferred preload based on network conditions (mobile-friendly)
const getPreferredPreload = () => {
  try {
    const nav = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    if (nav) {
      // If user enabled save-data, be conservative
      if (nav.saveData) return 'metadata';
      const t = (nav.effectiveType || '').toLowerCase();
      if (t.includes('4g') || t.includes('wifi')) return 'auto';
      // For slow networks (3g,2g) prefer metadata only
      return 'metadata';
    }
  } catch (e) { /* ignore */ }
  return 'metadata';
};

// --- Media metrics logger (keeps lightweight metrics locally for inspection) ---
window.__mediaMetrics = window.__mediaMetrics || [];
const logMediaMetric = (productId, mediaIndex, eventName) => {
  try {
    const item = { productId, mediaIndex, eventName, ts: Date.now(), perf: performance.now() };
    window.__mediaMetrics.push(item);
    try { localStorage.setItem('tangerine_media_metrics', JSON.stringify(window.__mediaMetrics.slice(-200))); } catch (e) {}
    // Also a console log to help debug in dev
    console.debug('mediaMetric', item);
  } catch (e) {}
};

// Small utility to export metrics as a JSON file
window.downloadMediaMetrics = () => {
  try {
    const data = JSON.stringify(window.__mediaMetrics || []);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `tangerine_media_metrics_${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
  } catch (e) { console.warn('export failed', e); }
};

// Register Service Worker (cautious - only when supported and site served over https or localhost)
if ('serviceWorker' in navigator) {
  try {
    navigator.serviceWorker.register('/sw.js').then(reg => {
      console.info('ServiceWorker registered', reg.scope);
    }).catch(err => console.warn('SW register failed', err));
  } catch (e) { console.warn('SW registration exception', e); }
}

// ===== LOGO =====
const LOGO_URL = "https://i.imgur.com/opUOZzu.jpeg";

// ===== CONFIGURATION (PRIX EN EUROS) =====
const PRICES = {
  wpff: 18,
  doublestatic: 14,
  freshfrozen: 8
};

const MIN_SPEND = 200; // Minimum spend in euros

const DELIVERY_PRICES = {
  rabat: { name: 'Rabat', price: 0, emoji: 'üëë', featured: true, estimatedDays: 1 },
  casablanca: { name: 'Casablanca', price: 50, emoji: 'üèôÔ∏è', estimatedDays: 1 },
  marrakech: { name: 'Marrakech', price: 150, emoji: 'üïå', estimatedDays: 2 },
  agadir: { name: 'Agadir', price: 200, emoji: 'üèñÔ∏è', estimatedDays: 2 },
  tangier: { name: 'Tanger', price: 100, emoji: '‚õµ', estimatedDays: 1 }
};

const PROMO_CODES = {
  'HARAGAZZ': { discount: 0.15, label: '-15%' }
};

const CRYPTO_ADDRESSES = {
  solana: '8XKBLvWkbQKyAYWGMXHhmUUzvXeZCnFEo9uzeqa8fS8V'
};

const PRODUCTS = [
  { 
    id: 't1', 
    category: 'wpff', 
    name: 'Tropicali', 
    emoji: 'ü•≠', 
    media: [
      'https://file.garden/aRCOOh-cGER2BR_t/tropicali_1.mp4',
      'https://file.garden/aRCOOh-cGER2BR_t/tropicali_2.mp4',
      'https://file.garden/aRCOOh-cGER2BR_t/tropicali_3.mp4'
    ], 
    posters: [
      'https://file.garden/aRCOOh-cGER2BR_t/IMG_1258_converted.avif',
      'https://file.garden/aRCOOh-cGER2BR_t/IMG_1259_converted.avif',
      'https://file.garden/aRCOOh-cGER2BR_t/IMG_1248.avif'
    ],
    thumbnail: 'https://file.garden/aRCOOh-cGER2BR_t/IMG_1241.avif',
    desc: 'Profil tropical intense avec notes de mangue fra√Æche et fruits exotiques. Effet √©nergisant et cr√©atif.' 
  },
  { 
    id: 't2', 
    category: 'wpff', 
    name: 'Kush Mints', 
    emoji: 'üçµ', 
    media: [
      'https://file.garden/aRCOOh-cGER2BR_t/kush_1.mp4',
      'https://file.garden/aRCOOh-cGER2BR_t/kush_2.mp4'
    ], 
    posters: [
      'https://file.garden/aRCOOh-cGER2BR_t/IMG_1239.avif',
      'https://file.garden/aRCOOh-cGER2BR_t/IMG_1243.avif'
    ],
    thumbnail: 'https://file.garden/aRCOOh-cGER2BR_t/IMG_1239.avif',
    desc: 'Ar√¥mes menthol√©s et terreux avec notes de cookies. Relaxation profonde et sensation apaisante prolong√©e.' 
  },
  { 
    id: 'ds1', 
    category: 'doublestatic', 
    name: 'Tropi Tangie', 
    emoji: 'üçä', 
    media: ['https://file.garden/aRCOOh-cGER2BR_t/tropi_tangie.mp4'], 
    posters: ['https://file.garden/aRCOOh-cGER2BR_t/IMG_1254.avif'],
    thumbnail: 'https://file.garden/aRCOOh-cGER2BR_t/IMG_1254.avif',
    desc: 'Explosion d\'agrumes et tangerine juteuse. Parfait pour la journ√©e, √©nergisant et euphorisant.' 
  },
  { 
    id: 'ds2', 
    category: 'doublestatic', 
    name: 'Miracle Alien Cookies', 
    emoji: 'üç™', 
    media: ['https://file.garden/aRCOOh-cGER2BR_t/mac.mp4'], 
    posters: ['https://file.garden/aRCOOh-cGER2BR_t/IMG_1245%20(1).avif'],
    thumbnail: 'https://file.garden/aRCOOh-cGER2BR_t/IMG_1245%20(1).avif',
    desc: 'Saveur gourmande de cookies fra√Æchement cuits et cr√®me onctueuse. Une exp√©rience douce et r√©confortante.' 
  },
  { 
    id: 'ds3', 
    category: 'doublestatic', 
    name: 'Tchikita Banana', 
    emoji: 'üçå', 
    media: ['https://file.garden/aRCOOh-cGER2BR_t/banana.mp4'], 
    posters: ['https://file.garden/aRCOOh-cGER2BR_t/IMG_1247.avif'],
    thumbnail: 'https://file.garden/aRCOOh-cGER2BR_t/IMG_1247.avif',
    desc: 'Douceur fruit√©e de banane m√ªre avec finale sucr√©e. Effet relaxant et apaisant.' 
  },
  { 
    id: 'ds4', 
    category: 'doublestatic', 
    name: 'Gelato Cheesecake', 
    emoji: 'üç∞', 
    media: ['https://file.garden/aRCOOh-cGER2BR_t/cheesecake.mp4'], 
    posters: ['https://file.garden/aRCOOh-cGER2BR_t/IMG_1253.avif'],
    thumbnail: 'https://file.garden/aRCOOh-cGER2BR_t/IMG_1253.avif',
    desc: 'Texture cr√©meuse et profil sucr√© avec ar√¥mes de dessert raffin√©. Une douceur irr√©sistible.' 
  },
  { 
    id: 'ds5', 
    category: 'doublestatic', 
    name: 'Tropicana Cherry', 
    emoji: 'üçí', 
    media: ['https://file.garden/aRCOOh-cGER2BR_t/cherry.mp4'], 
    posters: ['https://file.garden/aRCOOh-cGER2BR_t/IMG_1252.avif'],
    thumbnail: 'https://file.garden/aRCOOh-cGER2BR_t/IMG_1252.avif',
    desc: 'Cerise tropicale juteuse et sucr√©e avec finale rafra√Æchissante. √âquilibre parfait.' 
  },
  { 
    id: 'ff1', 
    category: 'freshfrozen', 
    name: 'Grape Pie X Biscotti', 
    emoji: 'üçá', 
    media: ['https://file.garden/aRCOOh-cGER2BR_t/grape.mp4'], 
    posters: ['https://file.garden/aRCOOh-cGER2BR_t/IMG_1246.avif'],
    thumbnail: 'https://file.garden/aRCOOh-cGER2BR_t/IMG_1246.avif',
    desc: 'Raisin doux m√©lang√© √† des notes de biscuits croquants. Harmonie subtile et saveur √©l√©gante.' 
  }
];

const CATEGORIES = [
  { id: 'all', label: 'Tous', emoji: '‚ú®', gradient: 'from-[#f97316] to-[#16a34a]' },
  { id: 'wpff', label: 'WPFF', emoji: 'üíé', gradient: 'from-[#2563eb] to-[#06b6d4]' },
  { id: 'doublestatic', label: 'Double Static', emoji: '‚ö°', gradient: 'from-yellow-500 to-orange-500' },
  { id: 'freshfrozen', label: 'Fresh Frozen', emoji: '‚ùÑÔ∏è', gradient: 'from-[#2563eb] to-[#06b6d4]' }
];

const WELCOME_STORAGE_KEY = 'tangerine_welcome_shown';

const QUANTITY_OPTIONS = [5, 10, 20];
const MIN_QUANTITY = 5;

// ===== ANALYTICS TRACKING =====
const trackEvent = (eventName, eventData = {}) => {
  if (typeof umami !== 'undefined') {
    umami.track(eventName, eventData);
  }
};

// ===== STORAGE UTILITIES =====
const StorageManager = {
  async saveCart(cart) {
    try {
      await window.storage.set('tangerine_cart', JSON.stringify(cart));
      return true;
    } catch (error) {
      console.error('Storage error:', error);
      return false;
    }
  },
  
  async loadCart() {
    try {
      const result = await window.storage.get('tangerine_cart');
      return result ? JSON.parse(result.value) : [];
    } catch (error) {
      return [];
    }
  },
  
  async saveDeliveryCity(city) {
    try {
      await window.storage.set('tangerine_delivery_city', city);
      return true;
    } catch (error) {
      console.error('Storage error:', error);
      return false;
    }
  },
  
  async loadDeliveryCity() {
    try {
      const result = await window.storage.get('tangerine_delivery_city');
      return result ? result.value : 'rabat';
    } catch (error) {
      return 'rabat';
    }
  },
  
  async savePaymentMethod(method) {
    try {
      await window.storage.set('tangerine_payment_method', method);
      return true;
    } catch (error) {
      console.error('Storage error:', error);
      return false;
    }
  },
  
  async loadPaymentMethod() {
    try {
      const result = await window.storage.get('tangerine_payment_method');
      return result ? result.value : 'cash';
    } catch (error) {
      return 'cash';
    }
  },
  
  async savePromoCode(code) {
    try {
      await window.storage.set('tangerine_promo_code', code);
      return true;
    } catch (error) {
      console.error('Storage error:', error);
      return false;
    }
  },
  
  async loadPromoCode() {
    try {
      const result = await window.storage.get('tangerine_promo_code');
      return result ? result.value : '';
    } catch (error) {
      return '';
    }
  },
  
  async saveWishlist(wishlist) {
    try {
      await window.storage.set('tangerine_wishlist', JSON.stringify(wishlist));
      return true;
    } catch (error) {
      console.error('Storage error:', error);
      return false;
    }
  },
  
  async loadWishlist() {
    try {
      const result = await window.storage.get('tangerine_wishlist');
      return result ? JSON.parse(result.value) : [];
    } catch (error) {
      return [];
    }
  },
  
  async saveFavorites(favorites) {
    try {
      await window.storage.set('tangerine_favorites', JSON.stringify(favorites));
      return true;
    } catch (error) {
      console.error('Storage error:', error);
      return false;
    }
  },
  
  async loadFavorites() {
    try {
      const result = await window.storage.get('tangerine_favorites');
      return result ? JSON.parse(result.value) : [];
    } catch (error) {
      return [];
    }
  },
  
  async saveOrderHistory(orders) {
    try {
      await window.storage.set('tangerine_order_history', JSON.stringify(orders));
      return true;
    } catch (error) {
      console.error('Storage error:', error);
      return false;
    }
  },
  
  async loadOrderHistory() {
    try {
      const result = await window.storage.get('tangerine_order_history');
      return result ? JSON.parse(result.value) : [];
    } catch (error) {
      return [];
    }
  },
  
  async saveUser(user) {
    try {
      await window.storage.set('tangerine_user', JSON.stringify(user));
      return true;
    } catch (error) {
      console.error('Storage error:', error);
      return false;
    }
  },
  
  async loadUser() {
    try {
      const result = await window.storage.get('tangerine_user');
      return result ? JSON.parse(result.value) : null;
    } catch (error) {
      return null;
    }
  },
  
  async saveTheme(theme) {
    try {
      await window.storage.set('tangerine_theme', theme);
      return true;
    } catch (error) {
      console.error('Storage error:', error);
      return false;
    }
  },
  
  async loadTheme() {
    try {
      const result = await window.storage.get('tangerine_theme');
      return result ? result.value : 'dark'; // Default to dark
    } catch (error) {
      return 'dark';
    }
  }
};

// ===== OPTIMIZED LOADING SCREEN =====
const LoadingScreen = ({ onComplete }) => {
  useEffect(() => {
    trackEvent('page_load', { page: 'loading' });
    const timer = setTimeout(() => onComplete(), 800);
    return () => clearTimeout(timer);
  }, [onComplete]);

  return (
    <div className="fixed inset-0 bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 z-50 flex flex-col items-center justify-center">
      <img
        src={LOGO_URL}
        alt="Tangerine"
        className="w-24 h-24 rounded-3xl mb-6 animate-pulse glow object-cover"
        onError={(e) => {
          e.target.src = 'https://s10.aconvert.com/convert/p3r68-cdx67/avr8y-z3sxq.jpg';
        }}
      />
      
      <h1 className="text-4xl font-black gradient-text mb-2 animate-fade-in-up">TANGERINE</h1>
      <p className="text-white/50 text-sm mb-6">Premium Quality</p>
      
      <div className="w-48 h-1 bg-white/10 rounded-full overflow-hidden">
        <div 
          className="h-full bg-gradient-to-r from-orange-500 via-pink-500 to-orange-600 rounded-full"
          style={{ animation: 'progressBar 0.8s ease-out forwards' }}
        />
      </div>
    </div>
  );
};

// ===== OPTIMIZED BACKGROUND =====
const ParticlesBackground = React.memo(() => {
  const canvasRef = useRef(null);

  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const ctx = canvas.getContext('2d', { alpha: true });
    let animationFrameId;
    let particles = [];

    const initParticles = () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      particles = [];

      const particleCount = Math.min(25, Math.floor(canvas.width * canvas.height / 20000));
      for (let i = 0; i < particleCount; i++) {
        particles.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height,
          radius: Math.random() * 1.5 + 0.5,
          dx: (Math.random() - 0.5) * 0.4,
          dy: (Math.random() - 0.5) * 0.4,
          opacity: Math.random() * 0.4 + 0.2,
          color: ['249, 115, 22', '236, 72, 153', '59, 130, 246'][Math.floor(Math.random() * 3)]
        });
      }
    };

    const animate = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      particles.forEach((p) => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(${p.color}, ${p.opacity})`;
        ctx.fill();

        p.x += p.dx;
        p.y += p.dy;

        if (p.x < 0 || p.x > canvas.width) p.dx *= -1;
        if (p.y < 0 || p.y > canvas.height) p.dy *= -1;
      });

      animationFrameId = requestAnimationFrame(animate);
    };

    initParticles();
    animate();

    const handleResize = () => initParticles();
    window.addEventListener('resize', handleResize);

    return () => {
      cancelAnimationFrame(animationFrameId);
      window.removeEventListener('resize', handleResize);
    };
  }, []);

  return <canvas ref={canvasRef} className="fixed top-0 left-0 w-full h-full pointer-events-none z-0 opacity-50" />;
});

// ===== OPTIMIZED PRODUCT CARD =====
const ProductCard = React.memo(({ product, onAddToCart, onViewDetails, isInWishlist, onToggleWishlist, isInitiallyVisible = false }) => {
  const [videoState, setVideoState] = useState('thumbnail');
  const [isVisible, setIsVisible] = useState(isInitiallyVisible);
  const videoRef = useRef(null);
  const cardRef = useRef(null);
  const observerRef = useRef(null);
  const productKey = useMemo(() => product.id || product.name || 'unknown', [product.id, product.name]);

  const forcePlay = useCallback((reason, retryCount = 0) => {
    const video = videoRef.current;
    if (!video || videoState === 'error') {
      return;
    }

    video.muted = true;
    video.playsInline = true;
    video.setAttribute('muted', '');
    video.setAttribute('playsinline', '');

    video.play()
      .then(() => {
        logMediaMetric(productKey, 0, `play_success_${reason}`);
      })
      .catch((error) => {
        logMediaMetric(productKey, 0, `play_error_${reason}`);
        if (retryCount < 5 && (isVisible || isInitiallyVisible)) {
          const delay = 200 * (retryCount + 1);
          setTimeout(() => forcePlay(reason, retryCount + 1), delay);
        }
      });
  }, [isVisible, isInitiallyVisible, productKey, videoState]);

  useEffect(() => {
    let isCurrentMount = true;
    let loadStartTime;

    // Start preparing video immediately for instant playback
    if (videoState === 'thumbnail') {
      setVideoState('loading');
      loadStartTime = performance.now();
      
      // Start loading immediately, don't wait for intersection
      if (videoRef.current && product.media[0]) {
        window.videoManager.prepareVideo(videoRef.current, product.media[0])
          .then(() => {
            if (!isCurrentMount) return;
            const loadTime = performance.now() - loadStartTime;
            setVideoState('loaded');
            logMediaMetric(productKey, 0, `load_success_${Math.round(loadTime)}ms`);
          })
          .catch(error => {
            if (!isCurrentMount) return;
            setVideoState('error');
            logMediaMetric(productKey, 0, `load_error_${error?.message || 'unknown'}`);
          });
      }
      
      trackEvent('product_view', { product: product.name, category: product.category });
    }
    
    // OPTIMISATION #2: Autoplay am√©lior√© - force play d√®s que visible
    try {
      observerRef.current = new IntersectionObserver((entries) => {
        const [entry] = entries;
        if (!entry || !videoRef.current) return;
        
        setIsVisible(entry.isIntersecting);
        logMediaMetric(productKey, 0, entry.isIntersecting ? 'observer_enter' : 'observer_exit');
        
        if (entry.isIntersecting) {
          forcePlay('observer');
        } else {
          // Pause quand pas visible
          if (videoRef.current) {
            try {
              videoRef.current.pause();
              videoRef.current.currentTime = 0; // Reset pour rejouer depuis le d√©but
            } catch(e) {}
          }
        }
      }, { 
        threshold: [0.5], // Augment√© √† 50% pour √™tre plus pr√©cis
        rootMargin: '50px' // R√©duit pour √©viter de charger trop t√¥t
      });
    } catch (error) {
      console.error('IntersectionObserver setup failed:', error);
    }

    if (cardRef.current) observerRef.current.observe(cardRef.current);
    
    return () => {
      if (observerRef.current) observerRef.current.disconnect();
      isCurrentMount = false;
    };
  }, [videoState, product.name, product.category, forcePlay, productKey]);

  useEffect(() => {
    if (videoState === 'loaded' && (isInitiallyVisible || isVisible)) {
      forcePlay(isInitiallyVisible ? 'initial_loaded' : 'visible_loaded');
    }
  }, [videoState, isInitiallyVisible, isVisible, forcePlay]);

  useEffect(() => {
    if (isVisible) {
      forcePlay('visibility_change');
    }
  }, [isVisible, forcePlay]);

  const handleQuickAdd = useCallback((qty, e) => {
    e.stopPropagation();

    const button = e.currentTarget;
    if (button) {
      button.classList.add('tap-state');
      setTimeout(() => button.classList.remove('tap-state'), 260);
    }

    onAddToCart(product, qty, PRICES[product.category] * qty);
    trackEvent('quick_add_to_cart', { 
      product: product.name, 
      quantity: qty, 
      price: PRICES[product.category] * qty 
    });
  }, [product, onAddToCart]);

  const handleVideoLoad = useCallback(() => {
    setVideoState('loaded');
    logMediaMetric(productKey, 0, 'card_loadeddata');
  }, [productKey]);

  const handleVideoError = useCallback(() => {
    setVideoState('error');
    logMediaMetric(productKey, 0, 'card_error');
  }, [productKey]);

  return (
    <div 
      ref={cardRef}
      className={`snap-center flex-shrink-0 w-80 glass rounded-3xl p-5 card-hover relative overflow-hidden group ${
        videoState === 'loaded' && (isVisible || isInitiallyVisible) ? 'card-playing' : ''
      }`}
    >
      <div className="card-halo" aria-hidden="true"></div>
      {onToggleWishlist && (
        <WishlistButton
          product={product}
          isInWishlist={isInWishlist}
          onToggle={onToggleWishlist}
        />
      )}
      <div 
        onClick={() => {
          onViewDetails(product);
          trackEvent('product_detail_view', { product: product.name });
        }}
        className="relative h-60 rounded-2xl overflow-hidden bg-black/30 mb-4 cursor-pointer"
        role="button"
        tabIndex={0}
        onKeyDown={(e) => e.key === 'Enter' && onViewDetails(product)}
      >
        <img
          src={product.thumbnail}
          loading="lazy"
          alt={product.name}
          className={`absolute inset-0 w-full h-full object-cover transition-all duration-300 ${
            videoState === 'loaded' ? 'opacity-0' : 'opacity-100'
          }`}
        />

        {videoState !== 'thumbnail' && videoState !== 'error' && (
          <video
            ref={videoRef}
            data-product-id={product.id || product.name}
            src={product.media[0]}
            className="absolute inset-0 w-full h-full object-cover video-smooth"
            autoPlay
            loop
            muted
            playsInline
            preload={getPreferredPreload()}
            poster={(product.posters && product.posters[0]) || product.thumbnail}
            fetchpriority="high"
            onLoadedData={handleVideoLoad}
            onError={handleVideoError}
          />
          )}

        {videoState === 'loading' && (
          <div className="absolute inset-0 flex items-center justify-center bg-black/20 z-10">
            <div className="w-10 h-10 border-3 border-orange-500 border-t-transparent rounded-full spinner"></div>
          </div>
        )}

        {videoState === 'error' && (
          <div className="absolute inset-0 flex flex-col items-center justify-center bg-gradient-to-b from-red-500/10 to-transparent z-10">
            <span className="text-4xl mb-2">‚ö†Ô∏è</span>
            <p className="text-white/60 text-xs">Vid√©o indisponible</p>
          </div>
        )}

        <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity" />
        
        <div className="absolute bottom-3 left-0 right-0 text-center opacity-0 group-hover:opacity-100 transition-opacity">
          <span className="text-white text-sm font-semibold bg-black/50 backdrop-blur-sm px-4 py-2 rounded-full">
            üëÅÔ∏è D√©tails
          </span>
        </div>
      </div>
      <div className="mb-4">
        <div className="flex items-center gap-2 mb-2">
          <span className="text-3xl">{product.emoji}</span>
          <h3 className="text-white font-bold text-lg flex-1">{product.name}</h3>
          <span className="text-orange-400 font-bold text-xs bg-orange-500/20 px-2 py-1 rounded-lg">
            {PRICES[product.category]}‚Ç¨/g
          </span>
        </div>
        <p className="text-white/60 text-sm line-clamp-2">{product.desc}</p>
      </div>

      <div className="flex gap-2">
        {[5, 10, 20].map(qty => (
          <button
            key={qty}
            onClick={(e) => handleQuickAdd(qty, e)}
            className="flex-1 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 active:scale-95 text-white font-bold py-3 rounded-xl transition-all text-sm"
          >
            {qty}g<br/><span className="text-xs opacity-90">{PRICES[product.category] * qty}‚Ç¨</span>
          </button>
        ))}
      </div>
    </div>
  );
});

// ===== PROMO CODE COMPONENT =====
const PromoCodeInput = ({ appliedPromo, onApplyPromo, onRemovePromo }) => {
  const [promoInput, setPromoInput] = useState('');
  const [error, setError] = useState('');

  const handleApply = () => {
    const upperCode = promoInput.toUpperCase().trim();
    if (PROMO_CODES[upperCode]) {
      onApplyPromo(upperCode);
      setError('');
      trackEvent('promo_code_applied', { code: upperCode });
    } else {
      setError('Code invalide');
      setTimeout(() => setError(''), 2000);
    }
  };

  return (
    <div className="glass rounded-2xl p-4 space-y-3 animate-slide-up">
      <div className="flex items-center gap-2 mb-2">
        <span className="text-xl">üéüÔ∏è</span>
        <h3 className="text-white font-bold">Code promo</h3>
      </div>

      {appliedPromo ? (
        <div className="glass-dark rounded-xl p-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-500 rounded-xl flex items-center justify-center">
              <span className="text-xl">‚úì</span>
            </div>
            <div>
              <p className="text-white font-bold text-sm">{appliedPromo}</p>
              <p className="text-green-400 text-xs font-semibold">{PROMO_CODES[appliedPromo].label} appliqu√©</p>
            </div>
          </div>
          <button
            onClick={onRemovePromo}
            className="bg-red-500/20 hover:bg-red-500/40 text-red-400 px-3 py-2 rounded-lg transition-all active:scale-90 text-sm font-semibold"
          >
            ‚úï
          </button>
        </div>
      ) : (
        <div className="space-y-2">
          <input
            type="text"
            value={promoInput}
            onChange={(e) => setPromoInput(e.target.value)}
            onKeyPress={(e) => e.key === 'Enter' && handleApply()}
            placeholder="Entrez votre code"
            className="w-full glass text-white px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-orange-500 placeholder-white/40 uppercase"
          />
          {error && (
            <p className="text-red-400 text-xs font-semibold animate-fade-in-up">{error}</p>
          )}
          <button
            onClick={handleApply}
            className="w-full bg-gradient-to-r from-orange-500 to-pink-500 hover:from-orange-600 hover:to-pink-600 text-white font-bold py-3 rounded-xl transition-all active:scale-95"
          >
            Appliquer
          </button>
        </div>
      )}
    </div>
  );
};

// ===== CRYPTO ADDRESS DISPLAY =====
const CryptoAddressDisplay = ({ crypto, address }) => {
  const [copied, setCopied] = useState(false);

  const handleCopy = () => {
    navigator.clipboard.writeText(address);
    setCopied(true);
    trackEvent('crypto_address_copied', { crypto });
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <div className="glass rounded-2xl p-4 space-y-3 animate-slide-up">
      <div className="flex items-center gap-3 mb-2">
        <div className="w-10 h-10 bg-gradient-to-br from-purple-500 to-blue-500 rounded-xl flex items-center justify-center">
          <span className="text-xl">üí∞</span>
        </div>
        <div>
          <p className="text-white font-bold">Solana (SOL)</p>
          <p className="text-white/60 text-xs">Copiez l'adresse ci-dessous</p>
        </div>
      </div>
      
      <div className="glass-dark rounded-xl p-3 break-all">
        <p className="text-white/90 text-xs font-mono">{address}</p>
      </div>
      
      <button
        onClick={handleCopy}
        className={`w-full ${
          copied 
            ? 'bg-green-500 hover:bg-green-600' 
            : 'bg-gradient-to-r from-purple-500 to-blue-500 hover:from-purple-600 hover:to-blue-600'
        } text-white font-bold py-3 rounded-xl transition-all active:scale-95`}
      >
        {copied ? '‚úÖ Copi√© !' : 'üìã Copier l\'adresse'}
      </button>
    </div>
  );
};

// ===== PAYMENT METHOD SELECTOR =====
const PaymentMethodSelector = ({ selectedMethod, onMethodChange, showCryptoAddress }) => {
  return (
    <div className="glass rounded-2xl p-4 space-y-3">
      <div className="flex items-center gap-2 mb-2">
        <span className="text-xl">üí≥</span>
        <h3 className="text-white font-bold">Mode de paiement</h3>
      </div>
      
      <div className="grid grid-cols-2 gap-3">
        <button
          onClick={() => onMethodChange('cash')}
          className={`${
            selectedMethod === 'cash'
              ? 'bg-gradient-to-r from-green-500 to-emerald-500 scale-105 glow'
              : 'glass hover:bg-white/10'
          } text-white font-semibold py-4 px-3 rounded-xl transition-all text-sm active:scale-95`}
        >
          <div className="text-2xl mb-1">üíµ</div>
          <div>Esp√®ces</div>
        </button>
        
        <button
          onClick={() => onMethodChange('crypto')}
          className={`${
            selectedMethod === 'crypto'
              ? 'bg-gradient-to-r from-purple-500 to-blue-500 scale-105 glow'
              : 'glass hover:bg-white/10'
          } text-white font-semibold py-4 px-3 rounded-xl transition-all text-sm active:scale-95`}
        >
          <div className="text-2xl mb-1">ü™ô</div>
          <div>Crypto</div>
        </button>
      </div>
      
      {selectedMethod === 'crypto' && showCryptoAddress && (
        <div className="space-y-3 mt-4">
          <button
            onClick={() => showCryptoAddress('solana')}
            className="w-full glass hover:bg-white/10 text-white font-semibold py-3 px-4 rounded-xl transition-all active:scale-95 flex items-center justify-between"
          >
            <div className="flex items-center gap-3">
              <div className="w-8 h-8 bg-gradient-to-br from-purple-500 to-blue-500 rounded-lg flex items-center justify-center text-sm">
                ‚óé
              </div>
              <span>Solana</span>
            </div>
            <span className="text-white/60">‚Üí</span>
          </button>
        </div>
      )}
    </div>
  );
};

// ===== CONFIRMATION MODAL =====
const ConfirmationModal = ({ isOpen, onConfirm, onCancel, cart, deliveryCity, total, paymentMethod, discount, subtotal, deliveryPrice }) => {
  if (!isOpen) return null;

  const deliveryInfo = DELIVERY_PRICES[deliveryCity];

  return (
    <div 
      className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[80] flex items-center justify-center p-4 animate-fade-in-up"
      onClick={onCancel}
    >
      <div 
        className="glass-dark rounded-3xl max-w-md w-full animate-zoom-in max-h-[90vh] overflow-y-auto"
        onClick={(e) => e.stopPropagation()}
      >
        <div className="p-6 border-b border-white/10">
          <div className="flex items-center gap-3 mb-2">
            <span className="text-3xl">‚úÖ</span>
            <h3 className="text-2xl font-bold text-white">Confirmer</h3>
          </div>
          <p className="text-white/60 text-sm">V√©rifiez avant de valider</p>
        </div>

        <div className="p-6 space-y-4">
          <div className="space-y-2">
            {cart.map((item, idx) => (
              <div key={idx} className="glass rounded-xl p-3 flex items-center gap-3">
                <span className="text-2xl">{item.product.emoji}</span>
                <div className="flex-1 min-w-0">
                  <p className="text-white font-semibold text-sm truncate">{item.product.name}</p>
                  <p className="text-white/60 text-xs">{item.quantity}g √ó {PRICES[item.product.category]}‚Ç¨</p>
                </div>
                <span className="text-orange-400 font-bold text-sm">{item.totalPrice}‚Ç¨</span>
              </div>
            ))}
          </div>

          <div className="glass rounded-xl p-4 space-y-2">
            <div className="flex justify-between text-white/80 text-sm">
              <span>Sous-total:</span>
              <span className="font-bold">{subtotal}‚Ç¨</span>
            </div>
            {discount > 0 && (
              <>
                <div className="flex justify-between text-green-400 text-sm">
                  <span>üéüÔ∏è R√©duction:</span>
                  <span className="font-bold">-{discount}‚Ç¨</span>
                </div>
                <div className="flex items-center gap-2 text-green-400 text-xs font-semibold">
                  <span>üíö</span>
                  <span>Vous avez √©conomis√© {discount}‚Ç¨ !</span>
                </div>
              </>
            )}
            {deliveryPrice > 0 && (
              <>
                <div className="flex justify-between text-white/80 text-sm">
                  <div className="flex items-center gap-2">
                    <span>{deliveryInfo.emoji}</span>
                    <span>Livraison:</span>
                  </div>
                  <span className="font-bold">{deliveryPrice}‚Ç¨</span>
                </div>
                <div className="text-white/60 text-xs">
                  ‚è±Ô∏è Livraison estim√©e: {deliveryInfo.estimatedDays} jour{deliveryInfo.estimatedDays > 1 ? 's' : ''}
                </div>
              </>
            )}
            {deliveryPrice === 0 && (
              <>
                <div className="flex items-center gap-2 text-green-400 text-sm">
                  <span>üéâ</span>
                  <span className="font-semibold">Livraison gratuite √† Rabat !</span>
                </div>
                <div className="text-white/60 text-xs">
                  ‚è±Ô∏è Livraison estim√©e: {deliveryInfo.estimatedDays} jour{deliveryInfo.estimatedDays > 1 ? 's' : ''}
                </div>
              </>
            )}
            <div className="flex justify-between text-white/80 text-sm pt-2 border-t border-white/20">
              <span>Paiement:</span>
              <span className="font-bold">{paymentMethod === 'cash' ? 'üíµ Esp√®ces' : 'ü™ô Crypto'}</span>
            </div>
            <div className="border-t border-white/20 pt-2 flex justify-between">
              <span className="text-white font-bold">Total:</span>
              <span className="gradient-text font-black text-2xl">{total}‚Ç¨</span>
            </div>
          </div>
        </div>

        <div className="p-6 border-t border-white/10 flex gap-3">
          <button
            onClick={onCancel}
            className="flex-1 glass hover:bg-white/10 text-white font-bold py-3 rounded-xl transition-all active:scale-95"
          >
            Annuler
          </button>
          <button
            onClick={onConfirm}
            className="flex-1 bg-gradient-to-r from-orange-500 via-pink-500 to-orange-500 hover:from-orange-600 hover:via-pink-600 hover:to-orange-600 text-white font-bold py-3 rounded-xl transition-all hover:scale-105 active:scale-95 glow"
          >
            ‚úÖ Valider
          </button>
        </div>
      </div>
    </div>
  );
};

// ===== CONTACT MODAL =====
const ContactModal = ({ isOpen, onClose }) => {
  if (!isOpen) return null;

  return (
    <div 
      className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in-up"
      onClick={onClose}
    >
      <div 
        className="glass-dark rounded-3xl max-w-md w-full animate-slide-up max-h-[90vh] overflow-y-auto"
        onClick={(e) => e.stopPropagation()}
      >
        <div className="p-6 border-b border-white/10 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <span className="text-3xl">üí¨</span>
            <h3 className="text-2xl font-bold text-white">Contact</h3>
          </div>
          <button
            onClick={onClose}
            className="text-white/60 hover:text-white text-3xl leading-none transition-all"
          >
            √ó
          </button>
        </div>

        <div className="p-6 space-y-6">
          <div className="text-center">
            <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center text-4xl mx-auto mb-4 float">
              üì±
            </div>
            <h4 className="text-white font-bold text-xl mb-2">Commandez maintenant</h4>
            <p className="text-white/60 text-sm mb-6">Contactez-nous sur Telegram</p>
          </div>

          <a
            href="https://t.me/Tangerine_212"
            target="_blank"
            rel="noopener noreferrer"
            onClick={() => trackEvent('contact_telegram_click')}
            className="block w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 text-white font-bold py-4 rounded-2xl transition-all hover:scale-105 active:scale-95 glow text-center"
          >
            üì≤ Ouvrir Telegram
          </a>

          <div className="glass rounded-2xl p-4 text-center">
            <p className="text-white font-bold mb-1">@Tangerine_212</p>
            <p className="text-white/60 text-sm">Disponible 24/7</p>
          </div>

          <div className="border-t border-white/20 pt-6">
            <h4 className="text-white font-bold text-lg mb-4 flex items-center gap-2">
              <span>üí≥</span>
              <span>Modes de paiement accept√©s</span>
            </h4>
            
            <div className="space-y-3">
              <div className="glass rounded-xl p-4">
                <div className="flex items-center gap-3 mb-2">
                  <span className="text-2xl">üíµ</span>
                  <span className="text-white font-semibold">Esp√®ces</span>
                </div>
                <p className="text-white/60 text-sm">Toutes devises accept√©es</p>
              </div>
              
              <div className="glass rounded-xl p-4">
                <div className="flex items-center gap-3 mb-3">
                  <span className="text-2xl">ü™ô</span>
                  <span className="text-white font-semibold">Cryptomonnaies</span>
                </div>
                <div className="grid grid-cols-2 gap-2">
                  <div className="glass-dark rounded-lg p-2 text-center">
                    <div className="text-lg mb-1">‚óé</div>
                    <p className="text-white/80 text-xs font-semibold">Solana</p>
                  </div>
                  <div className="glass-dark rounded-lg p-2 text-center">
                    <div className="text-lg mb-1">‚ÇÆ</div>
                    <p className="text-white/80 text-xs font-semibold">USDT</p>
                  </div>
                  <div className="glass-dark rounded-lg p-2 text-center">
                    <div className="text-lg mb-1">‚Çø</div>
                    <p className="text-white/80 text-xs font-semibold">Bitcoin</p>
                  </div>
                  <div className="glass-dark rounded-lg p-2 text-center">
                    <div className="text-lg mb-1">Œû</div>
                    <p className="text-white/80 text-xs font-semibold">Ethereum</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div className="flex gap-4 text-white/60 text-xs">
            <div className="flex-1 flex items-center justify-center gap-2 glass rounded-xl py-3">
              <span>üöö</span>
              <span>Rapide</span>
            </div>
            <div className="flex-1 flex items-center justify-center gap-2 glass rounded-xl py-3">
              <span>‚úÖ</span>
              <span>Qualit√©</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

// ===== OPTIMIZED CART DRAWER =====
const CartDrawer = ({ isOpen, onClose, cart, onUpdateQuantity, onRemoveItem, onCheckout, deliveryCity, onDeliveryCityChange, paymentMethod, onPaymentMethodChange, appliedPromo, onApplyPromo, onRemovePromo }) => {
  const [showCryptoAddress, setShowCryptoAddress] = useState(null);
  
  const subtotal = useMemo(() => 
    cart.reduce((sum, item) => sum + item.totalPrice, 0), 
    [cart]
  );

  const deliveryPrice = DELIVERY_PRICES[deliveryCity].price;
  const orderTotal = subtotal + deliveryPrice;

  const discount = useMemo(() => {
    if (appliedPromo && PROMO_CODES[appliedPromo]) {
      return Math.round(orderTotal * PROMO_CODES[appliedPromo].discount);
    }
    return 0;
  }, [appliedPromo, orderTotal]);

  const total = orderTotal - discount;
  // Minimum spend applies only to product subtotal (excluding delivery)
  const meetsMinimum = subtotal >= MIN_SPEND;
  const remainingAmount = Math.max(0, MIN_SPEND - subtotal);
  const progressPercentage = Math.min(100, (subtotal / MIN_SPEND) * 100);

  const handleQuantityChange = useCallback((index, delta) => {
    const item = cart[index];
    const unitPrice = PRICES[item.product.category];
    const newQuantity = Math.max(MIN_QUANTITY, item.quantity + delta);
    onUpdateQuantity(index, newQuantity, unitPrice * newQuantity);
    trackEvent('cart_quantity_change', { 
      product: item.product.name, 
      newQuantity 
    });
  }, [cart, onUpdateQuantity]);

  useEffect(() => {
    document.body.style.overflow = isOpen ? 'hidden' : 'unset';
    if (isOpen) {
      trackEvent('cart_opened', { itemCount: cart.length });
    }
    return () => { document.body.style.overflow = 'unset'; };
  }, [isOpen, cart.length]);

  const handleShowCryptoAddress = (crypto) => {
    setShowCryptoAddress(crypto);
    trackEvent('crypto_address_shown', { crypto });
  };

  return (
    <>
      {isOpen && (
        <div 
          className="fixed inset-0 bg-black/60 z-40 backdrop-blur-sm"
          onClick={onClose}
        />
      )}
      
      <div 
        className={`fixed top-0 right-0 h-full w-full max-w-md glass-dark shadow-2xl transition-transform duration-300 z-[60] flex flex-col ${
          isOpen ? 'translate-x-0' : 'translate-x-full'
        }`}
      >
        <div className="flex items-center justify-between p-6 border-b border-white/10">
          <div className="flex items-center gap-3">
            <span className="text-3xl">üõí</span>
            <div>
              <h2 className="text-2xl font-bold text-white">Panier</h2>
              <p className="text-white/60 text-sm">{cart.length} article{cart.length > 1 ? 's' : ''}</p>
            </div>
          </div>
          <button 
            onClick={onClose} 
            className="text-white/60 hover:text-white text-4xl leading-none transition-all"
          >
            √ó
          </button>
        </div>

        <div className="flex-1 overflow-y-auto p-4 space-y-3">
          {cart.length === 0 ? (
            <div className="text-center mt-20 animate-fade-in-up">
              <div className="text-7xl mb-4 float">üõí</div>
              <p className="text-white/60 text-lg font-semibold mb-2">Panier vide</p>
              <p className="text-white/40 text-sm">Ajoutez des produits</p>
            </div>
          ) : (
            <>
              {cart.map((item, idx) => (
                <div 
                  key={`${item.product.id}-${idx}`}
                  className="glass rounded-2xl p-4 animate-slide-in-right"
                  style={{ animationDelay: `${idx * 30}ms` }}
                >
                  <div className="flex gap-3 mb-3">
                    <div className="w-14 h-14 rounded-xl bg-gradient-to-br from-orange-500/20 to-pink-500/20 flex items-center justify-center text-2xl flex-shrink-0">
                      {item.product.emoji}
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="text-white font-semibold text-sm truncate">{item.product.name}</p>
                      <p className="text-orange-400 text-xs font-bold">{item.quantity}g √ó {PRICES[item.product.category]}‚Ç¨</p>
                      <p className="text-white/90 font-bold text-lg">{item.totalPrice}‚Ç¨</p>
                    </div>
                    <button
                      onClick={() => {
                        onRemoveItem(idx);
                        trackEvent('cart_item_removed', { product: item.product.name });
                      }}
                      className="bg-red-500/20 hover:bg-red-500/40 text-red-400 px-3 rounded-xl transition-all self-start active:scale-90"
                    >
                      üóëÔ∏è
                    </button>
                  </div>
                  
                  <div className="flex items-center gap-2">
                    <button
                      onClick={() => handleQuantityChange(idx, -1)}
                      disabled={item.quantity <= MIN_QUANTITY}
                      className="bg-white/10 hover:bg-white/20 disabled:opacity-30 disabled:cursor-not-allowed text-white px-3 py-2 rounded-lg transition-all font-bold flex-1 active:scale-95"
                    >
                      -1g
                    </button>
                    <div className="flex-1 text-center">
                      <span className="text-white font-bold text-lg">{item.quantity}g</span>
                    </div>
                    <button
                      onClick={() => handleQuantityChange(idx, 1)}
                      className="bg-white/10 hover:bg-white/20 text-white px-3 py-2 rounded-lg transition-all font-bold flex-1 active:scale-95"
                    >
                      +1g
                    </button>
                  </div>
                </div>
              ))}

              <PromoCodeInput
                appliedPromo={appliedPromo}
                onApplyPromo={onApplyPromo}
                onRemovePromo={onRemovePromo}
              />

              <PaymentMethodSelector
                selectedMethod={paymentMethod}
                onMethodChange={onPaymentMethodChange}
                showCryptoAddress={handleShowCryptoAddress}
              />

              {showCryptoAddress && (
                <CryptoAddressDisplay
                  crypto={showCryptoAddress}
                  address={CRYPTO_ADDRESSES[showCryptoAddress]}
                />
              )}

              <div className="glass rounded-2xl p-4 space-y-3">
                <div className="flex items-center gap-2 mb-2">
                  <span className="text-xl">üöö</span>
                  <h3 className="text-white font-bold">Livraison</h3>
                </div>
                <div className="grid grid-cols-2 gap-2">
                  {Object.entries(DELIVERY_PRICES).map(([key, info]) => (
                    <button
                      key={key}
                      onClick={() => {
                        onDeliveryCityChange(key);
                        trackEvent('delivery_city_changed', { city: info.name });
                      }}
                      className={`${
                        deliveryCity === key
                          ? 'bg-gradient-to-r from-orange-500 to-pink-500 scale-105 glow'
                          : 'glass hover:bg-white/10'
                      } text-white font-semibold py-3 px-2 rounded-xl transition-all text-sm relative active:scale-95`}
                    >
                      <div className="flex items-center justify-center gap-1">
                        <span>{info.emoji}</span>
                        <span>{info.name}</span>
                      </div>
                      <div className={`text-xs mt-1 ${info.price === 0 ? 'text-green-300 font-bold' : 'opacity-80'}`}>
                        {info.price === 0 ? 'GRATUIT' : `${info.price}‚Ç¨`}
                      </div>
                      {info.featured && (
                        <span className="absolute -top-1 -right-1 bg-green-500 text-white text-xs px-2 py-0.5 rounded-full">
                          ‚≠ê
                        </span>
                      )}
                    </button>
                  ))}
                </div>
              </div>
            </>
          )}
        </div>

        {cart.length > 0 && (
          <div className="border-t border-white/10 p-6 space-y-4 bg-black/30">
            <div className="space-y-2">
              <div className="flex justify-between text-white/80 text-sm">
                <span>Sous-total:</span>
                <span className="font-bold">{subtotal}‚Ç¨</span>
              </div>
              {discount > 0 && (
                <>
                  <div className="flex justify-between text-green-400 text-sm">
                    <span>üéüÔ∏è R√©duction:</span>
                    <span className="font-bold">-{discount}‚Ç¨</span>
                  </div>
                  <div className="flex items-center gap-2 text-green-400 text-xs font-semibold">
                    <span>üíö</span>
                    <span>Vous avez √©conomis√© {discount}‚Ç¨ !</span>
                  </div>
                </>
              )}
              {deliveryPrice > 0 ? (
                <>
                  <div className="flex justify-between text-white/80 text-sm">
                    <div className="flex items-center gap-2">
                      <span>{DELIVERY_PRICES[deliveryCity].emoji}</span>
                      <span>Livraison:</span>
                    </div>
                    <span className="font-bold">{deliveryPrice}‚Ç¨</span>
                  </div>
                  <div className="text-white/60 text-xs">
                    ‚è±Ô∏è Livraison estim√©e: {DELIVERY_PRICES[deliveryCity].estimatedDays} jour{DELIVERY_PRICES[deliveryCity].estimatedDays > 1 ? 's' : ''}
                  </div>
                </>
              ) : (
                <>
                  <div className="flex items-center gap-2 text-green-400 text-sm">
                    <span>üéâ</span>
                    <span className="font-semibold">Livraison gratuite !</span>
                  </div>
                  <div className="text-white/60 text-xs">
                    ‚è±Ô∏è Livraison estim√©e: {DELIVERY_PRICES[deliveryCity].estimatedDays} jour{DELIVERY_PRICES[deliveryCity].estimatedDays > 1 ? 's' : ''}
                  </div>
                </>
              )}
              <div className="border-t border-white/20 pt-2 flex justify-between">
                <span className="text-white font-bold text-lg">Total:</span>
                <span className="gradient-text font-black text-3xl">{total}‚Ç¨</span>
              </div>
            </div>

            {/* Minimum Spend Indicator - Compact Version */}
            <div className="glass rounded-xl p-3 space-y-2 animate-slide-up">
              {meetsMinimum ? (
                <div className="flex items-center gap-2">
                  <div className="w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-500 rounded-lg flex items-center justify-center flex-shrink-0">
                    <span className="text-lg">‚úì</span>
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="text-white font-bold text-xs">Minimum atteint</p>
                    <p className="text-green-400 text-xs">Pr√™t √† commander</p>
                  </div>
                </div>
              ) : (
                <div className="space-y-2">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-1.5">
                      <span className="text-sm">üéØ</span>
                      <p className="text-white font-bold text-xs">Min. {MIN_SPEND}‚Ç¨</p>
                    </div>
                    <p className="text-white/80 font-semibold text-xs">{subtotal}‚Ç¨/{MIN_SPEND}‚Ç¨</p>
                  </div>
                  
                  <div className="relative h-2 bg-white/10 rounded-full overflow-hidden">
                    <div 
                      className="absolute inset-0 bg-gradient-to-r from-orange-500 via-pink-500 to-orange-500 rounded-full transition-all duration-500 ease-out"
                      style={{ width: `${progressPercentage}%` }}
                    />
                  </div>
                  
                  <p className="text-white/60 text-xs text-center">
                    Ajoutez <span className="text-orange-400 font-bold">{remainingAmount.toFixed(0)}‚Ç¨</span> de plus
                  </p>
                </div>
              )}
            </div>

            <button
              onClick={onCheckout}
              disabled={!meetsMinimum}
              className={`w-full font-bold py-4 rounded-2xl transition-all ${
                meetsMinimum
                  ? 'bg-gradient-to-r from-orange-500 via-pink-500 to-orange-500 hover:from-orange-600 hover:via-pink-600 hover:to-orange-600 text-white hover:scale-105 active:scale-95 glow'
                  : 'bg-white/10 text-white/40 cursor-not-allowed opacity-50'
              }`}
            >
              {meetsMinimum ? 'üöÄ Commander' : `üéØ Ajoutez ${remainingAmount.toFixed(0)}‚Ç¨ de produits`}
            </button>
          </div>
        )}
      </div>
    </>
  );
};

// ===== NOTIFICATION =====
const Notification = ({ message, isVisible, type = 'success' }) => {
  const icons = { success: '‚úÖ', error: '‚ùå', info: '‚ÑπÔ∏è' };

  return (
    <div 
      className={`fixed bottom-28 left-1/2 -translate-x-1/2 glass-dark px-6 py-4 rounded-2xl shadow-2xl transition-all duration-300 z-50 flex items-center gap-3 ${
        isVisible ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-8 pointer-events-none'
      }`}
    >
      <span className="text-2xl">{icons[type]}</span>
      <span className="text-white font-semibold text-sm">{message}</span>
    </div>
  );
};

// ===== CONFETTI COMPONENT =====
const Confetti = ({ trigger }) => {
  useEffect(() => {
    if (!trigger) return;
    
    const colors = ['#f97316', '#ec4899', '#f59e0b', '#8b5cf6', '#06b6d4'];
    const confettiCount = 50;
    
    for (let i = 0; i < confettiCount; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti';
      confetti.style.left = `${Math.random() * 100}%`;
      confetti.style.top = '-10px';
      confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.width = `${Math.random() * 10 + 5}px`;
      confetti.style.height = `${Math.random() * 10 + 5}px`;
      confetti.style.animationDelay = `${Math.random() * 0.5}s`;
      confetti.style.animationDuration = `${Math.random() * 2 + 2}s`;
      document.body.appendChild(confetti);
      
      setTimeout(() => confetti.remove(), 3000);
    }
  }, [trigger]);
  
  return null;
};

// ===== SEARCH COMPONENT =====
const SearchBar = ({ onSearch, searchQuery, onQueryChange }) => {
  const [isFocused, setIsFocused] = useState(false);
  const inputRef = useRef(null);

  const handleSearch = (e) => {
    e.preventDefault();
    onSearch(searchQuery);
    trackEvent('search_performed', { query: searchQuery });
  };

  return (
    <form onSubmit={handleSearch} className="relative w-full max-w-md mx-auto mb-6">
      <div className={`glass rounded-2xl p-3 flex items-center gap-3 transition-all ${
        isFocused ? 'ring-2 ring-orange-500' : ''
      }`}>
        <span className="text-2xl">üîç</span>
        <input
          ref={inputRef}
          type="text"
          value={searchQuery}
          onChange={(e) => onQueryChange(e.target.value)}
          onFocus={() => setIsFocused(true)}
          onBlur={() => setIsFocused(false)}
          placeholder="Rechercher un produit..."
          className="flex-1 bg-transparent text-white placeholder-white/40 outline-none text-sm"
        />
        {searchQuery && (
          <button
            type="button"
            onClick={() => {
              onQueryChange('');
              onSearch('');
            }}
            className="text-white/60 hover:text-white transition-all"
          >
            ‚úï
          </button>
        )}
        <button
          type="submit"
          className="bg-gradient-to-r from-orange-500 to-pink-500 hover:from-orange-600 hover:to-pink-600 text-white px-4 py-2 rounded-xl font-bold text-sm transition-all active:scale-95"
        >
          Rechercher
        </button>
      </div>
    </form>
  );
};

// ===== FILTER AND SORT COMPONENT =====
const FilterSortBar = ({ onFilterChange, onSortChange, selectedCategory, sortBy }) => {
  const [showFilters, setShowFilters] = useState(false);
  const [priceRange, setPriceRange] = useState({ min: 0, max: 1000 });

  return (
    <div className="mb-6 space-y-3">
      <div className="flex items-center gap-3 overflow-x-auto pb-2">
        <button
          onClick={() => setShowFilters(!showFilters)}
          className="flex-shrink-0 glass hover:bg-white/10 text-white px-4 py-2 rounded-xl font-semibold text-sm transition-all active:scale-95 flex items-center gap-2"
        >
          <span>üîΩ</span>
          <span>Filtres</span>
        </button>
        
        <select
          value={sortBy}
          onChange={(e) => onSortChange(e.target.value)}
          className="flex-shrink-0 glass text-white px-4 py-2 rounded-xl font-semibold text-sm outline-none focus:ring-2 focus:ring-orange-500"
        >
          <option value="default">Trier par</option>
          <option value="price-low">Prix: Croissant</option>
          <option value="price-high">Prix: D√©croissant</option>
          <option value="name">Nom: A-Z</option>
        </select>
      </div>
      
      {showFilters && (
        <div className="glass rounded-2xl p-4 space-y-3 animate-slide-down">
          <div>
            <label className="text-white font-semibold text-sm mb-2 block">Prix (‚Ç¨)</label>
            <div className="flex items-center gap-3">
              <input
                type="number"
                min="0"
                max="1000"
                value={priceRange.min}
                onChange={(e) => setPriceRange({ ...priceRange, min: parseInt(e.target.value) || 0 })}
                className="flex-1 glass text-white px-3 py-2 rounded-xl outline-none focus:ring-2 focus:ring-orange-500 text-sm"
                placeholder="Min"
              />
              <span className="text-white/60">-</span>
              <input
                type="number"
                min="0"
                max="1000"
                value={priceRange.max}
                onChange={(e) => setPriceRange({ ...priceRange, max: parseInt(e.target.value) || 1000 })}
                className="flex-1 glass text-white px-3 py-2 rounded-xl outline-none focus:ring-2 focus:ring-orange-500 text-sm"
                placeholder="Max"
              />
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// ===== WISHLIST COMPONENT =====
const WishlistButton = ({ product, isInWishlist, onToggle }) => {
  return (
    <button
      onClick={(e) => {
        e.stopPropagation();
        onToggle(product);
      }}
      className={`absolute top-3 right-3 w-10 h-10 rounded-full flex items-center justify-center transition-all z-20 ${
        isInWishlist
          ? 'bg-red-500 hover:bg-red-600 text-white'
          : 'bg-black/50 hover:bg-black/70 text-white/80'
      } backdrop-blur-sm active:scale-90`}
      title={isInWishlist ? 'Retirer des favoris' : 'Ajouter aux favoris'}
    >
      <span className="text-xl">{isInWishlist ? '‚ù§Ô∏è' : 'ü§ç'}</span>
    </button>
  );
};

// ===== PRODUCT DETAIL MODAL =====
const ProductDetailModal = ({ product, onClose, onAddToCart, openViewer }) => {
  const [selectedQuantity, setSelectedQuantity] = useState(MIN_QUANTITY);
  const [selectedMediaIndex, setSelectedMediaIndex] = useState(0);
  const [mediaLoaded, setMediaLoaded] = useState(false);
  const videoRef = useRef(null);

  useEffect(() => {
    if (product) {
      trackEvent('product_detail_opened', { product: product.name });
      setSelectedMediaIndex(0);
      setMediaLoaded(false);
      
      // Force initial video load and play using VideoManager
      const src = product.media[0];
      if (src?.match(/\.(mp4|webm|ogg)(\?.*)?$/i) && videoRef.current) {
        window.videoManager.prepareVideo(videoRef.current, src)
          .then(() => {
            try { logMediaMetric(product.id || product.name || 'unknown', 0, 'detail_load_success'); } catch(e){}
          })
          .catch(error => {
            try { logMediaMetric(product.id || product.name || 'unknown', 0, 'detail_load_error', { error: error.message }); } catch(e){}
          });
      }
    }

    // Nettoyage lors de la fermeture du modal
    return () => {
      if (videoRef.current) {
        try {
          videoRef.current.pause();
          videoRef.current.currentTime = 0;
          videoRef.current.src = "";
          videoRef.current.load();
        } catch (e) { /* ignore */ }
      }
    };
  }, [product]);

  // When selectedMediaIndex changes, update the main media source smoothly
  useEffect(() => {
    if (!product) return;
    const src = product.media[selectedMediaIndex];
    setMediaLoaded(false);
    if (!src) return;

    if (src.match(/\.(mp4|webm|ogg)(\?.*)?$/i)) {
      if (videoRef.current) {
        // Prepare and swap to the new video source via VideoManager for instant playback
        window.videoManager.prepareVideo(videoRef.current, src)
          .then(() => {
            try { logMediaMetric(product.id || product.name || 'unknown', selectedMediaIndex, 'detail_swap_success'); } catch(e){}
            setMediaLoaded(true);
          })
          .catch(() => {
            // Leave mediaLoaded false; UI shows spinner and poster
          });
      }
    } else {
      // Non-video media; the <img> branch will render
      setMediaLoaded(true);
    }
  }, [product, selectedMediaIndex]);

  if (!product) return null;

  const price = PRICES[product.category] * selectedQuantity;

  const handleAddToCart = () => {
    onAddToCart(product, selectedQuantity, price);
    trackEvent('add_to_cart_from_detail', { 
      product: product.name, 
      quantity: selectedQuantity, 
      price 
    });
    onClose();
  };

  return (
    <div 
      className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fade-in-up"
      onClick={onClose}
    >
      <div 
        className="glass-dark rounded-3xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
        onClick={(e) => e.stopPropagation()}
      >
        <div className="relative">
          {/* Main media preview (image or video) - clicking opens fullscreen viewer */}
          <div
            onClick={() => openViewer && openViewer(product, selectedMediaIndex)}
            className="cursor-zoom-in relative w-full h-72 rounded-t-3xl overflow-hidden"
            role="button"
            tabIndex={0}
          >
            {product.media[selectedMediaIndex] && product.media[selectedMediaIndex].match(/\.(mp4|webm|ogg)(\?.*)?$/i) ? (
              <>
                {!mediaLoaded && (
                  <div className="absolute inset-0 flex items-center justify-center bg-black/40 backdrop-blur-sm z-10">
                    <div className="w-14 h-14 border-4 border-orange-500 border-t-transparent rounded-full spinner"></div>
                  </div>
                )}
                {/* Video with forced mobile autoplay */}
                <video
                  key={`main-${product.id}-${selectedMediaIndex}`}
                  ref={videoRef}
                  className="relative w-full h-72 object-cover video-smooth"
                  loop
                  muted
                  playsInline
                  autoPlay
                  poster={(product.posters && product.posters[selectedMediaIndex]) || product.thumbnail}
                  fetchpriority="high"
                  preload="auto"
                  onLoadedMetadata={() => {
                    // Ensure video is properly configured for mobile
                    if (videoRef.current) {
                      videoRef.current.muted = true;
                      videoRef.current.defaultMuted = true;
                      videoRef.current.playsInline = true;
                      videoRef.current.setAttribute('playsinline', '');
                      videoRef.current.setAttribute('muted', '');
                      try {
                        videoRef.current.play()
                          .then(() => {
                            setMediaLoaded(true);
                            try { logMediaMetric(product.id || product.name || 'unknown', selectedMediaIndex, 'detail_autoplay_success'); } catch(e){}
                          })
                          .catch(error => {
                            try { logMediaMetric(product.id || product.name || 'unknown', selectedMediaIndex, 'detail_autoplay_failed', { error: error.message }); } catch(e){}
                            // Retry once after a short delay
                            setTimeout(() => {
                              if (videoRef.current) videoRef.current.play().catch(() => {});
                            }, 500);
                          });
                      } catch(e) {}
                    }
                  }}
                />
              </>
            ) : (
              <img src={product.thumbnail} alt={product.name} loading="lazy" className="w-full h-72 object-cover" />
            )}

            <div className="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent" />

            <button
              onClick={(e) => {
                e.preventDefault();
                e.stopPropagation();
                // Arr√™ter la lecture de la vid√©o si elle existe
                if (videoRef.current) {
                  videoRef.current.pause();
                  videoRef.current.currentTime = 0;
                }
                onClose();
              }}
              className="absolute top-4 right-4 bg-black/60 backdrop-blur-sm text-white hover:bg-black/80 w-12 h-12 rounded-full transition-all flex items-center justify-center text-2xl z-20 active:scale-90"
            >
              ‚úï
            </button>

            <div className="absolute bottom-4 left-6">
              <div className="flex items-center gap-3">
                <span className="text-5xl">{product.emoji}</span>
                <h2 className="text-3xl font-black text-white">{product.name}</h2>
              </div>
            </div>
          </div>

          {/* Thumbnails / media selector */}
          <div 
            className="p-4 flex gap-3 overflow-x-auto hide-scrollbar"
            role="listbox"
            aria-label="S√©lecteur de m√©dias"
          >
      {product.media.map((m, idx) => (
              <button
                key={m + idx}
                onClick={() => { setSelectedMediaIndex(idx); setMediaLoaded(false); }}
                className={`rounded-xl overflow-hidden border-2 ${selectedMediaIndex === idx ? 'border-orange-400 ring-2 ring-orange-400/50' : 'border-white/10 hover:border-white/30'} p-0 transition-all focus:outline-none focus:ring-2 focus:ring-orange-400/50`}
                style={{ minWidth: 96, minHeight: 64 }}
                title={`Ouvrir m√©dia ${idx + 1}`}
                role="option"
                aria-selected={selectedMediaIndex === idx}
                tabIndex={0}
              >
                {m.match(/\.(mp4|webm|ogg)(\?.*)?$/i) ? (
                  <video 
                    src={m} 
                    className="w-24 h-16 object-cover video-smooth"
                    muted={true}
                    defaultMuted={true}
                    preload={getPreferredPreload()} 
                    playsInline 
                    fetchpriority="high"
                    poster={(product.posters && product.posters[idx]) || product.thumbnail}
                    onPlay={(e) => { 
                      try { 
                        e.target.muted = true; 
                        e.target.defaultMuted = true;
                        e.target.volume = 0; 
                      } catch(err){} 
                    }}
                    onLoadedMetadata={(e) => {
                      try {
                        const v = e.target;
                        v.muted = true;
                        v.defaultMuted = true;
                        v.volume = 0;
                        const w = v.videoWidth || 0;
                        const h = v.videoHeight || 0;
                        if (h > w) v.classList.add('is-portrait');
                        else v.classList.remove('is-portrait');
                      } catch (err) {}
                    }}
                  />
                ) : (
                  <img src={m} className="w-24 h-16 object-cover" loading="lazy" />
                )}
              </button>
            ))}
          </div>
        </div>

        <div className="p-6 space-y-6">
          <div>
            <h3 className="text-white font-bold text-lg mb-2">üìù Description</h3>
            <p className="text-white/80 leading-relaxed text-sm">{product.desc}</p>
          </div>

          <div className="glass p-4 rounded-2xl flex items-center justify-between">
            <div>
              <p className="text-white/60 text-sm mb-1">Prix unitaire</p>
              <p className="gradient-text font-black text-2xl">{PRICES[product.category]}‚Ç¨/g</p>
            </div>
          </div>

          <div>
            <h3 className="text-white font-bold text-lg mb-3">‚öñÔ∏è Quantit√© (min. {MIN_QUANTITY}g)</h3>
            <div className="grid grid-cols-3 gap-3 mb-4">
              {QUANTITY_OPTIONS.map(qty => (
                <button
                  key={qty}
                  onClick={() => setSelectedQuantity(qty)}
                  className={`${
                    selectedQuantity === qty
                      ? 'bg-gradient-to-r from-orange-500 to-pink-500 scale-105'
                      : 'glass hover:bg-white/10'
                  } text-white font-bold py-3 rounded-xl transition-all active:scale-95`}
                >
                  {qty}g
                </button>
              ))}
            </div>
            
            <div className="flex gap-3">
              <input
                type="number"
                min={MIN_QUANTITY}
                value={selectedQuantity}
                onChange={(e) => setSelectedQuantity(Math.max(MIN_QUANTITY, parseInt(e.target.value) || MIN_QUANTITY))}
                className="flex-1 glass text-white px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-orange-500 text-center font-bold"
                placeholder={`Min. ${MIN_QUANTITY}g`}
              />
              <div className="glass px-6 py-3 rounded-xl flex items-center">
                <span className="text-white font-bold text-xl">{price}‚Ç¨</span>
              </div>
            </div>
          </div>

          <button
            onClick={handleAddToCart}
            className="w-full bg-gradient-to-r from-orange-500 via-pink-500 to-orange-500 hover:from-orange-600 hover:via-pink-600 hover:to-orange-600 text-white font-bold py-4 rounded-2xl transition-all hover:scale-105 active:scale-95 glow flex items-center justify-center gap-2"
          >
            <span>üõí</span>
            <span>Ajouter ({price}‚Ç¨)</span>
          </button>
        </div>
      </div>
    </div>
  );
};

// ===== THEME TOGGLE COMPONENT =====
// ===== FULLSCREEN MEDIA VIEWER =====
const FullscreenViewer = ({ isOpen, product, startIndex = 0, onClose }) => {
  const [index, setIndex] = useState(startIndex || 0);
  const containerRef = useRef(null);
  const startX = useRef(0);
  const deltaX = useRef(0);
  const [isDragging, setIsDragging] = useState(false);
  const [dragOffset, setDragOffset] = useState(0);
  const dragThreshold = 0.15; // 15% width for swipe trigger
  const [isControlsVisible, setIsControlsVisible] = useState(true);
  const controlsTimerRef = useRef(null);

  // G√©rer l'affichage/masquage automatique des contr√¥les
  const resetControlsTimer = useCallback(() => {
    if (controlsTimerRef.current) {
      clearTimeout(controlsTimerRef.current);
    }
    setIsControlsVisible(true);
    controlsTimerRef.current = setTimeout(() => {
      setIsControlsVisible(false);
    }, 2500);
  }, []);

  useEffect(() => {
    setIndex(startIndex || 0);
  }, [startIndex, product]);

  useEffect(() => {
    if (!isOpen) return;
    
    const onKey = (e) => {
      if (e.key === 'ArrowRight') setIndex(i => Math.min(i + 1, (product?.media?.length || 1) - 1));
      if (e.key === 'ArrowLeft') setIndex(i => Math.max(i - 1, 0));
      if (e.key === 'Escape') onClose && onClose();
      resetControlsTimer();
    };

    window.addEventListener('keydown', onKey);
    resetControlsTimer();

    return () => {
      window.removeEventListener('keydown', onKey);
      if (controlsTimerRef.current) {
        clearTimeout(controlsTimerRef.current);
      }
    };
  }, [isOpen, product, onClose]);

  useEffect(() => {
    // Preload neighbors for smooth transitions
    if (!product || !product.media) return;
    const neighbors = [index - 1, index + 1].filter(i => i >= 0 && i < product.media.length);
    neighbors.forEach(i => {
      const src = product.media[i];
      if (!src) return;
      if (src.match(/\.(mp4|webm|ogg)(\?.*)?$/i)) {
        const v = document.createElement('video');
        v.src = src;
        v.preload = 'auto';
      } else {
        const img = new Image(); img.src = src;
      }
    });
  }, [index, product]);

  if (!isOpen || !product) return null;

  const goNext = () => setIndex(i => Math.min(i + 1, product.media.length - 1));
  const goPrev = () => setIndex(i => Math.max(i - 1, 0));

  const handleTouchStart = (e) => {
    setIsDragging(true);
    startX.current = e.touches[0].clientX;
    deltaX.current = 0;
  };

  const handleTouchMove = (e) => {
    if (!isDragging) return;
    deltaX.current = e.touches[0].clientX - startX.current;
    
    // Calculate offset as percentage of container width
    const containerWidth = containerRef.current?.clientWidth || 1;
    const offsetPercent = (deltaX.current / containerWidth);
    
    // Limit drag to next/prev media with resistance at ends
    const hasNext = index < (product.media.length - 1);
    const hasPrev = index > 0;
    
    // Apply resistance using a cubic function for smoother feel
    if ((!hasNext && offsetPercent < 0) || (!hasPrev && offsetPercent > 0)) {
      const resistance = 0.15;
      const resistedOffset = Math.sign(offsetPercent) * Math.pow(Math.abs(offsetPercent), 3) * resistance;
      setDragOffset(resistedOffset);
    } else {
      // Add some subtle resistance even within bounds for better feel
      const withinBoundsResistance = 0.85;
      setDragOffset(offsetPercent * withinBoundsResistance);
    }
  };

  const handleTouchEnd = () => {
    setIsDragging(false);
    
    // If movement exceeds threshold, change media
    if (Math.abs(dragOffset) > dragThreshold) {
      if (dragOffset < 0) goNext(); else goPrev();
    }
    
    // Reset offset
    setDragOffset(0);
    deltaX.current = 0;
  };

  return (
    <div className="fixed inset-0 z-[90] bg-black/95 flex items-center justify-center" onClick={onClose}>
      <div
        ref={containerRef}
        onClick={(e) => e.stopPropagation()}
        onTouchStart={handleTouchStart}
        onTouchMove={handleTouchMove}
        onTouchEnd={handleTouchEnd}
        onTouchCancel={handleTouchEnd}
        className="w-full h-full relative flex items-center justify-center"
      >
        {/* En-t√™te avec d√©grad√© et bouton de fermeture */}
        <div className="fixed top-0 left-0 right-0 h-24 z-50 pointer-events-none">
          <div className="absolute inset-0 bg-gradient-to-b from-black/60 to-transparent" />
          <button 
            onClick={(e) => { e.stopPropagation(); onClose(); }}
            className="absolute top-4 right-4 glass-dark hover:bg-white/10 text-white/90 hover:text-white w-10 h-10 rounded-full flex items-center justify-center transition-all active:scale-95 backdrop-blur-lg border border-white/10 pointer-events-auto"
            aria-label="Fermer"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5" className="w-5 h-5">
              <path d="M6 18L18 6M6 6l12 12" strokeLinecap="round" strokeLinejoin="round" />
            </svg>
          </button>
        </div>

        {index > 0 && (
          <button 
            onClick={() => { goPrev(); }} 
            className="absolute left-2 top-1/2 -translate-y-1/2 z-40 bg-black/40 hover:bg-black/60 backdrop-blur text-white w-12 h-12 rounded-full flex items-center justify-center transition-all active:scale-95"
          >‚óÄ</button>
        )}
        {index < product.media.length - 1 && (
          <button 
            onClick={() => { goNext(); }} 
            className="absolute right-2 top-1/2 -translate-y-1/2 z-40 bg-black/40 hover:bg-black/60 backdrop-blur text-white w-12 h-12 rounded-full flex items-center justify-center transition-all active:scale-95"
          >‚ñ∂</button>
        )}

        <div className="w-full overflow-hidden rounded-2xl">
          {product.media.map((m, idx) => (
            <div
              key={m + idx}
              style={{
                transform: `translateX(${100 * (idx - index) + (dragOffset * 100)}%)`,
                transition: isDragging ? 'none' : 'all 400ms cubic-bezier(0.4, 0, 0.2, 1)',
                opacity: Math.abs(idx - index) <= 1 ? 1 : 0,
                scale: isDragging ? '0.98' : '1',
                filter: isDragging ? 'brightness(0.9)' : 'brightness(1)'
              }}
              className="absolute inset-0 w-full h-full flex items-center justify-center touch-none select-none"
            >
              {m.match(/\.(mp4|webm|ogg)(\?.*)?$/i) ? (
                <video
                  src={m}
                  className="w-full max-h-[80vh] object-contain video-smooth"
                  autoPlay
                  muted={true}
                  defaultMuted={true}
                  controls
                  playsInline
                  preload={getPreferredPreload()}
                  fetchpriority={index === idx ? 'high' : 'low'}
                  onLoadedData={(e) => { 
                    try { 
                      // Ensure video is muted
                      e.target.muted = true;
                      e.target.defaultMuted = true;
                      e.target.volume = 0;
                      logMediaMetric(product.id || product.name || 'unknown', idx, 'viewer_loadeddata'); 
                    } catch(e){} 
                  }}
                  onPlay={(e) => {
                    try {
                      // Double check muting on play
                      e.target.muted = true;
                      e.target.volume = 0;
                    } catch(e){}
                  }}
                />
              ) : (
                <img src={m} loading="lazy" className="w-full max-h-[80vh] object-contain" />
              )}
            </div>
          ))}
        </div>

        {/* Indicateurs de m√©dias et barre de contr√¥le en bas */}
        <div className={`absolute bottom-0 left-0 right-0 z-40 transition-opacity duration-300 ${
          isControlsVisible ? 'opacity-100' : 'opacity-0'
        }`}>
          <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-black/30 to-transparent pointer-events-none" />
          <div className="relative p-4 flex flex-col items-center">
            {/* Points de navigation */}
            <div className="flex items-center gap-2 mb-2">
              {product.media.map((m, idx) => (
                <button 
                  key={m + idx} 
                  onClick={(e) => { e.stopPropagation(); setIndex(idx); }}
                  className={`w-1.5 h-1.5 rounded-full transition-all ${
                    idx === index 
                      ? 'bg-white scale-150' 
                      : 'bg-white/40 hover:bg-white/60'
                  }`}
                  title={`M√©dia ${idx + 1}`}
                />
              ))}
            </div>
            {/* Info sur le m√©dia actuel */}
            <div className="text-white/60 text-xs font-medium">
              {index + 1} / {product.media.length}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

const ThemeToggle = ({ theme, onToggle, cartOpen = false }) => {
  return (
    <button
      onClick={onToggle}
      className={`theme-toggle text-white ${cartOpen ? 'cart-open' : ''}`}
      title={theme === 'dark' ? 'Mode jour' : 'Mode nuit'}
      aria-label={theme === 'dark' ? 'Passer au mode jour' : 'Passer au mode nuit'}
    >
      {theme === 'dark' ? (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <circle cx="12" cy="12" r="5"/>
          <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
      ) : (
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
      )}
    </button>
  );
};

// ===== MAIN APP =====
const App = () => {
  const [selectedCategory, setSelectedCategory] = useState('all');
  const [cart, setCart] = useState([]);
  const [isCartOpen, setIsCartOpen] = useState(false);
  const [notification, setNotification] = useState({ message: '', isVisible: false, type: 'success' });
  const [selectedProduct, setSelectedProduct] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [showConfirmation, setShowConfirmation] = useState(false);
  const [isContactOpen, setIsContactOpen] = useState(false);
  const [deliveryCity, setDeliveryCity] = useState('rabat');
  const [paymentMethod, setPaymentMethod] = useState('cash');
  const [appliedPromo, setAppliedPromo] = useState('');
  const [wishlist, setWishlist] = useState([]);
  const [orderHistory, setOrderHistory] = useState([]);
  const [confettiTrigger, setConfettiTrigger] = useState(0);
  const [theme, setTheme] = useState('dark'); // Default to dark (base color)
  const [showParticles, setShowParticles] = useState(false);
  const [viewerOpen, setViewerOpen] = useState(false);
  const [viewerProduct, setViewerProduct] = useState(null);
  const [viewerStartIndex, setViewerStartIndex] = useState(0);
  const [showWelcome, setShowWelcome] = useState(false);
  const [welcomeRendered, setWelcomeRendered] = useState(false);
  const [headerReady, setHeaderReady] = useState(false);
  const [navReady, setNavReady] = useState(false);
  const [categoryProgress, setCategoryProgress] = useState(0);
  const welcomeTimerRef = useRef(null);
  const welcomeUnmountRef = useRef(null);
  const categoryScrollRef = useRef(null);

  const clearWelcomeTimers = useCallback(() => {
    if (welcomeTimerRef.current) {
      clearTimeout(welcomeTimerRef.current);
      welcomeTimerRef.current = null;
    }
    if (welcomeUnmountRef.current) {
      clearTimeout(welcomeUnmountRef.current);
      welcomeUnmountRef.current = null;
    }
  }, []);

  const markWelcomeSeen = useCallback(() => {
    try {
      if (typeof localStorage !== 'undefined') {
        localStorage.setItem(WELCOME_STORAGE_KEY, '1');
      }
    } catch (e) {
      /* ignore */
    }
  }, []);

  const handleDismissWelcome = useCallback((source = 'manual') => {
    clearWelcomeTimers();
    markWelcomeSeen();
    setShowWelcome(prev => {
      if (prev) {
        trackEvent('welcome_dismissed', { source });
      }
      return false;
    });
  }, [clearWelcomeTimers, markWelcomeSeen]);

  const openViewer = useCallback((product, startIndex = 0) => {
    setViewerProduct(product);
    setViewerStartIndex(startIndex || 0);
    setViewerOpen(true);
    // prevent background scroll
    document.body.style.overflow = 'hidden';
    trackEvent('viewer_opened', { product: product?.name, startIndex });
  }, []);

  const closeViewer = useCallback(() => {
    setViewerOpen(false);
    setViewerProduct(null);
    setViewerStartIndex(0);
    setSelectedProduct(null); // Also close detail modal when closing viewer
    document.body.style.overflow = 'unset';
    trackEvent('viewer_closed');
  }, []);

  useEffect(() => {
    const loadData = async () => {
      try {
        const [savedCart, savedCity, savedPayment, savedPromo, savedWishlist, savedOrderHistory, savedTheme] = await Promise.all([
          StorageManager.loadCart(),
          StorageManager.loadDeliveryCity(),
          StorageManager.loadPaymentMethod(),
          StorageManager.loadPromoCode(),
          StorageManager.loadWishlist(),
          StorageManager.loadOrderHistory(),
          StorageManager.loadTheme()
        ]);
        setCart(savedCart);
        setDeliveryCity(savedCity);
        setPaymentMethod(savedPayment);
        setAppliedPromo(savedPromo);
        setWishlist(savedWishlist);
        setOrderHistory(savedOrderHistory);
        if (savedTheme) {
          setTheme(savedTheme);
          document.documentElement.className = savedTheme === 'light' ? 'theme-light' : '';
        } else {
          // Default to dark mode
          document.documentElement.className = '';
        }
        // Decide whether to show particle background: disable on narrow screens or slow connections
        try {
          const nav = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
          const isFast = nav ? (nav.saveData ? false : (nav.effectiveType || '').toLowerCase().includes('4g')) : true;
          const allowParticles = isFast || window.innerWidth >= 360;
        setShowParticles(allowParticles);
          // Add a low-data CSS mode to reduce heavy visual effects for slow connections
          const isLowData = nav ? (nav.saveData || !((nav.effectiveType||'').toLowerCase().includes('4g'))) : false;
          if (isLowData) document.documentElement.classList.add('low-data');
          else document.documentElement.classList.remove('low-data');
        } catch (e) { setShowParticles(window.innerWidth > 700); }
      } catch (error) {
        console.error('Failed to load data:', error);
        // Ensure dark mode by default
        document.documentElement.className = '';
      }
    };
    loadData();
  }, []);

  useEffect(() => {
    if (isLoading || welcomeRendered) return;

    let alreadySeen = false;
    try {
      if (typeof localStorage !== 'undefined') {
        alreadySeen = localStorage.getItem(WELCOME_STORAGE_KEY) === '1';
      }
    } catch (e) {
      /* ignore */
    }

    setWelcomeRendered(true);

    if (alreadySeen) {
      markWelcomeSeen();
      return;
    }

    welcomeTimerRef.current = setTimeout(() => {
      welcomeTimerRef.current = null;
      setShowWelcome(true);
      markWelcomeSeen();
      trackEvent('welcome_shown');
    }, 200);

    welcomeUnmountRef.current = setTimeout(() => {
      welcomeUnmountRef.current = null;
      handleDismissWelcome('auto');
    }, 4200);

    return () => {
      clearWelcomeTimers();
    };
  }, [isLoading, welcomeRendered, markWelcomeSeen, handleDismissWelcome, clearWelcomeTimers]);

  useEffect(() => {
    const container = categoryScrollRef.current;
    if (!container) {
      setCategoryProgress(0);
      return;
    }

    const update = () => {
      const maxScroll = container.scrollWidth - container.clientWidth;
      if (maxScroll <= 0) {
        setCategoryProgress(1);
        return;
      }
      setCategoryProgress(Math.min(container.scrollLeft / maxScroll, 1));
    };

    update();
    container.addEventListener('scroll', update, { passive: true });
    window.addEventListener('resize', update);

    return () => {
      container.removeEventListener('scroll', update);
      window.removeEventListener('resize', update);
    };
  }, [CATEGORIES.length]);

  useEffect(() => {
    // Aggressive preloading for menu videos, especially on mobile
    if (isLoading) return;
    
    try {
      // On mobile, focus on immediate menu videos
      const isMobile = window.innerWidth <= 900 || /Mobi|Android/i.test(navigator.userAgent);
      const toPreload = PRODUCTS.slice(0, isMobile ? 3 : 5);
      
      // Immediate thumbnail preload
      toPreload.forEach(p => {
        if (p.thumbnail) {
          const img = new Image();
          img.src = p.thumbnail;
          img.fetchPriority = 'high';
        }
      });

      // Staggered video preload using VideoManager
      toPreload.forEach((p, index) => {
        const videoUrls = (p.media || []).slice(0, 1);
        videoUrls.forEach(src => {
          if (!src.match(/\.(mp4|webm|ogg)(\?.*)?$/i)) {
            const img = new Image();
            img.src = src;
            return;
          }

          // Use VideoManager for controlled loading
          setTimeout(() => {
            window.videoManager.preloadVideo(src);
          }, index * (isMobile ? 50 : 200));
        });
      });

      // On mobile, aggressively attempt to load and autoplay the visible/menu carousel videos
      try {
        const isMobile = window.innerWidth <= 900 || /Mobi|Android/i.test(navigator.userAgent || '');
        if (isMobile) {
          // Select first few video elements in the main carousel (menu area)
          const menuVideos = Array.from(document.querySelectorAll('main video')).slice(0, 5);
          menuVideos.forEach((v, idx) => {
            try {
              // Ensure attributes needed for mobile autoplay
              v.muted = true;
              v.defaultMuted = true;
              v.playsInline = true;
              v.setAttribute('playsinline', '');
              v.setAttribute('muted', '');
              // Prefer aggressive preload for immediate start
              try { v.preload = 'auto'; } catch (e) {}
              try { v.load(); } catch (e) {}

              // Attempt to play with a few retries (some mobile webviews require user gesture or retry)
              let attempts = 0;
              const tryPlay = () => {
                attempts += 1;
                v.play().then(() => {
                  try { logMediaMetric(v.dataset?.productId || `menu_video_${idx}`, 0, 'menu_autoplay_success'); } catch (e) {}
                }).catch(() => {
                  if (attempts < 4) setTimeout(tryPlay, 400 + attempts * 200);
                  else try { logMediaMetric(v.dataset?.productId || `menu_video_${idx}`, 0, 'menu_autoplay_failed'); } catch (e) {}
                });
              };
              tryPlay();
            } catch (e) { /* ignore per-video errors */ }
          });
        }
      } catch (e) { /* ignore overall */ }
    } catch (e) { /* ignore preload errors */ }
  }, [isLoading]);
  
  const handleThemeToggle = useCallback(async () => {
    const newTheme = theme === 'dark' ? 'light' : 'dark';
    setTheme(newTheme);
    document.documentElement.className = newTheme === 'light' ? 'theme-light' : '';
    await StorageManager.saveTheme(newTheme);
    trackEvent('theme_changed', { theme: newTheme });
  }, [theme]);

  const showNotification = useCallback((message, type = 'success') => {
    setNotification({ message, isVisible: true, type });
    setTimeout(() => setNotification({ message: '', isVisible: false, type: 'success' }), 2500);
  }, []);

  const addToCart = useCallback(async (product, quantity, price) => {
    if (quantity < MIN_QUANTITY) {
      showNotification(`Minimum ${MIN_QUANTITY}g par produit`, 'error');
      return;
    }
    
    const existingItemIndex = cart.findIndex(item => item.product.id === product.id);
    
    let newCart;
    if (existingItemIndex !== -1) {
      newCart = cart.map((item, idx) => {
        if (idx === existingItemIndex) {
          const newQuantity = item.quantity + quantity;
          const unitPrice = PRICES[product.category];
          return { ...item, quantity: newQuantity, totalPrice: unitPrice * newQuantity };
        }
        return item;
      });
    } else {
      newCart = [...cart, { product, quantity, totalPrice: price }];
    }
    
    setCart(newCart);
    await StorageManager.saveCart(newCart);
    showNotification(`${product.emoji} ${product.name} ajout√©`, 'success');
  }, [cart, showNotification]);

  const updateQuantity = useCallback(async (index, newQuantity, newPrice) => {
    const newCart = cart.map((item, idx) =>
      idx === index ? { ...item, quantity: newQuantity, totalPrice: newPrice } : item
    );
    setCart(newCart);
    await StorageManager.saveCart(newCart);
  }, [cart]);

  const removeFromCart = useCallback(async (index) => {
    const newCart = cart.filter((_, idx) => idx !== index);
    setCart(newCart);
    await StorageManager.saveCart(newCart);
    showNotification('Produit retir√©', 'info');
  }, [cart, showNotification]);

  const handleDeliveryCityChange = useCallback(async (city) => {
    setDeliveryCity(city);
    await StorageManager.saveDeliveryCity(city);
  }, []);

  const handlePaymentMethodChange = useCallback(async (method) => {
    setPaymentMethod(method);
    await StorageManager.savePaymentMethod(method);
    trackEvent('payment_method_changed', { method });
  }, []);

  const handleApplyPromo = useCallback(async (code) => {
    setAppliedPromo(code);
    await StorageManager.savePromoCode(code);
    showNotification(`Code ${code} appliqu√© !`, 'success');
  }, [showNotification]);

  const handleRemovePromo = useCallback(async () => {
    setAppliedPromo('');
    await StorageManager.savePromoCode('');
    showNotification('Code promo retir√©', 'info');
  }, [showNotification]);

  const handleCheckoutClick = useCallback(() => {
    if (cart.length === 0) {
      showNotification('Panier vide !', 'error');
      return;
    }
    
    const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
    const deliveryPrice = DELIVERY_PRICES[deliveryCity].price;
    const orderTotal = subtotal + deliveryPrice;
    const discount = appliedPromo && PROMO_CODES[appliedPromo] 
      ? Math.round(orderTotal * PROMO_CODES[appliedPromo].discount)
      : 0;
    const total = orderTotal - discount;
    
    // Minimum spend applies only to product subtotal (excluding delivery)
    if (subtotal < MIN_SPEND) {
      const remaining = MIN_SPEND - subtotal;
      showNotification(`Minimum de ${MIN_SPEND}‚Ç¨ requis (hors livraison). Ajoutez encore ${remaining.toFixed(0)}‚Ç¨ de produits`, 'error');
      return;
    }
    
    trackEvent('checkout_initiated', { itemCount: cart.length });
    setShowConfirmation(true);
  }, [cart, deliveryCity, appliedPromo, showNotification]);

  const handleConfirmOrder = useCallback(async () => {
    const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
    const deliveryPrice = DELIVERY_PRICES[deliveryCity].price;
    const orderTotal = subtotal + deliveryPrice;
    const discount = appliedPromo && PROMO_CODES[appliedPromo] 
      ? Math.round(orderTotal * PROMO_CODES[appliedPromo].discount)
      : 0;
    const totalPrice = orderTotal - discount;
    
    const message = cart
      .map(item => `${item.product.emoji} ${item.product.name} - ${item.quantity}g : ${item.totalPrice}‚Ç¨`)
      .join('\n');
    
    const paymentText = paymentMethod === 'cash' ? 'üíµ Esp√®ces' : 'ü™ô Crypto';
    const promoText = appliedPromo ? `\nüéüÔ∏è Code promo ${appliedPromo}: -${discount}‚Ç¨` : '';
    
    const order = {
      id: Date.now().toString(),
      date: new Date().toISOString(),
      items: cart,
      subtotal,
      deliveryPrice,
      discount,
      total: totalPrice,
      deliveryCity: DELIVERY_PRICES[deliveryCity].name,
      paymentMethod,
      promoCode: appliedPromo || null,
      estimatedDelivery: DELIVERY_PRICES[deliveryCity].estimatedDays
    };
    
    const newOrderHistory = [order, ...orderHistory];
    setOrderHistory(newOrderHistory);
    await StorageManager.saveOrderHistory(newOrderHistory);
    
    const telegramURL = `https://t.me/Tangerine_212?text=${encodeURIComponent(
      `üéâ NOUVELLE COMMANDE TANGERINE\n\n${message}\n\nüì¶ Sous-total: ${subtotal}‚Ç¨${promoText}\nüöö Livraison ${DELIVERY_PRICES[deliveryCity].name}: ${deliveryPrice === 0 ? 'GRATUIT' : deliveryPrice + '‚Ç¨'}\nüí≥ Paiement: ${paymentText}\n\nüí∞ TOTAL: ${totalPrice}‚Ç¨`
    )}`;
    
    trackEvent('order_confirmed', { 
      total: totalPrice, 
      itemCount: cart.length,
      deliveryCity: DELIVERY_PRICES[deliveryCity].name,
      paymentMethod,
      promoCode: appliedPromo || 'none',
      discount
    });
    
    window.open(telegramURL, '_blank');
    
    setCart([]);
    StorageManager.saveCart([]);
    setIsCartOpen(false);
    setShowConfirmation(false);
    setConfettiTrigger(prev => prev + 1);
    showNotification('Commande envoy√©e ! ‚úÖ', 'success');
  }, [cart, deliveryCity, paymentMethod, appliedPromo, showNotification, orderHistory]);


  const handleToggleWishlist = useCallback(async (product) => {
    const isInWishlist = wishlist.some(item => item.id === product.id);
    let newWishlist;
    
    if (isInWishlist) {
      newWishlist = wishlist.filter(item => item.id !== product.id);
      showNotification(`${product.emoji} ${product.name} retir√© des favoris`, 'info');
    } else {
      newWishlist = [...wishlist, product];
      showNotification(`${product.emoji} ${product.name} ajout√© aux favoris`, 'success');
    }
    
    setWishlist(newWishlist);
    await StorageManager.saveWishlist(newWishlist);
    trackEvent('wishlist_toggled', { product: product.name, added: !isInWishlist });
  }, [wishlist, showNotification]);

  const filteredProducts = useMemo(() => {
    return selectedCategory === 'all'
      ? PRODUCTS
      : PRODUCTS.filter(p => p.category === selectedCategory);
  }, [selectedCategory]);

  const handleCategoryChange = useCallback((categoryId) => {
    setSelectedCategory(categoryId);
    trackEvent('category_changed', { category: categoryId });
  }, []);

  if (isLoading) {
    return <LoadingScreen onComplete={() => setIsLoading(false)} />;
  }

  const subtotal = cart.reduce((sum, item) => sum + item.totalPrice, 0);
  const deliveryPrice = DELIVERY_PRICES[deliveryCity].price;
  const orderTotal = subtotal + deliveryPrice;
  const discount = appliedPromo && PROMO_CODES[appliedPromo] 
    ? Math.round(orderTotal * PROMO_CODES[appliedPromo].discount)
    : 0;
  const total = orderTotal - discount;
  // Minimum spend applies only to product subtotal (excluding delivery)
  const meetsMinimum = subtotal >= MIN_SPEND;
  const cartProgress = Math.min(100, (subtotal / MIN_SPEND) * 100);

  // Theme-aware background classes
  const bgClasses = theme === 'light' 
    ? 'min-h-screen bg-gradient-to-br from-[#f8fafc] via-[#edf4ef] to-[#f8fafc] relative overflow-hidden'
    : 'min-h-screen bg-gradient-to-br from-[#05090b] via-[#0b1411] to-[#05090b] relative overflow-hidden';
  
  const textClasses = theme === 'light' ? 'text-slate-900' : 'text-white';
  const textSecondaryClasses = theme === 'light' ? 'text-slate-600' : 'text-white/60';

  return (
    <div className={bgClasses}>
      {welcomeRendered && (
        <div className={`welcome-toast ${showWelcome ? 'show' : ''}`} role="status" aria-live="polite" onClick={() => handleDismissWelcome('manual')}>
          <span className="text-xl">üçä</span>
          <span className="welcome-text">Welcome</span>
        </div>
      )}
      <div className="background-aurora" aria-hidden="true">
        <div className="aurora-blob aurora-blob-1"></div>
        <div className="aurora-blob aurora-blob-2"></div>
        <div className="aurora-blob aurora-blob-3"></div>
        <div className="noise-overlay"></div>
      </div>
      {showParticles && <ParticlesBackground />}

      <ThemeToggle theme={theme} onToggle={handleThemeToggle} cartOpen={isCartOpen} />

      <header className="relative z-10 max-w-7xl mx-auto pb-4 px-4 telegram-header">
        <div className="flex items-center justify-center gap-4 mb-6">
          <img
            src={LOGO_URL}
            alt="Logo"
            loading="lazy"
            className="w-16 h-16 rounded-2xl border-2 border-white/20 shadow-xl float object-cover"
            onError={(e) => {
              e.target.src = 'https://s10.aconvert.com/convert/p3r68-cdx67/avr8y-z3sxq.jpg';
            }}
          />
          <div>
            <h1 className="text-3xl font-black gradient-text">TANGERINE</h1>
            <p className={`text-sm ${textSecondaryClasses}`}>Premium Quality</p>
          </div>
        </div>

        <div className="flex gap-3 overflow-x-auto pb-2 scroll-smooth" ref={categoryScrollRef}>
          {CATEGORIES.map((cat) => (
            <button
              key={cat.id}
              onClick={() => handleCategoryChange(cat.id)}
              className={`flex-shrink-0 px-6 py-3 rounded-2xl font-bold transition-all ${
                selectedCategory === cat.id
                  ? `bg-gradient-to-r ${cat.gradient} text-white scale-105 glow`
                  : `glass ${textClasses} opacity-70 hover:opacity-100 hover:scale-105`
              }`}
            >
              <span className="mr-2">{cat.emoji}</span>
              {cat.label}
            </button>
          ))}
        </div>
        <div className="category-progress">
          <div className="category-progress-bar" style={{ transform: `scaleX(${categoryProgress})` }}></div>
        </div>
      </header>

      <main className={`relative z-10 max-w-7xl mx-auto px-4 pb-32`}>
        {filteredProducts.length === 0 ? (
          <div className="text-center py-20 animate-fade-in-up">
            <div className="text-7xl mb-4">üîç</div>
            <p className={`${textClasses} text-xl font-semibold mb-2`}>Aucun produit</p>
            <p className={`${textSecondaryClasses} text-sm`}>Essayez une autre cat√©gorie</p>
          </div>
        ) : (
          <div className="flex gap-5 overflow-x-auto pb-6 snap-x scroll-smooth">
            {filteredProducts.map((product, index) => (
              <ProductCard
                key={product.id}
                product={product}
                onAddToCart={addToCart}
                onViewDetails={setSelectedProduct}
                isInWishlist={wishlist.some(item => item.id === product.id)}
                onToggleWishlist={handleToggleWishlist}
                isInitiallyVisible={index === 0}
              />
            ))}
          </div>
        )}
      </main>

      <nav className={`fixed bottom-4 left-1/2 -translate-x-1/2 z-40 glass-dark px-6 py-3 rounded-full shadow-2xl flex gap-4 items-center`}>
        <button 
          onClick={() => handleCategoryChange('all')}
          className={`${textClasses} hover:scale-110 active:scale-95 transition-all p-2`}
          title="Accueil"
        >
          <span className="text-2xl">üè†</span>
        </button>

        <button
          onClick={() => setIsCartOpen(true)}
          className="relative bg-gradient-to-r from-orange-500 to-pink-500 hover:from-orange-600 hover:to-pink-600 text-white px-6 py-3 rounded-full font-bold transition-all hover:scale-105 active:scale-95 glow"
        >
          <span className="mr-2">üõí</span>
          Panier
          {cart.length > 0 && (
            <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center font-bold animate-pulse">
              {cart.length}
            </span>
          )}
          {cart.length > 0 && !meetsMinimum && (
            <div className="absolute -bottom-1 left-0 right-0 h-1 bg-white/20 rounded-full overflow-hidden">
              <div 
                className="h-full bg-gradient-to-r from-orange-400 to-pink-400 transition-all duration-500 ease-out"
                style={{ width: `${cartProgress}%` }}
              />
            </div>
          )}
        </button>

        <button
          onClick={() => setIsContactOpen(true)}
          className={`${textClasses} hover:scale-110 active:scale-95 transition-all p-2`}
          title="Contact"
        >
          <span className="text-2xl">üí¨</span>
        </button>
      </nav>

      <CartDrawer
        isOpen={isCartOpen}
        onClose={() => setIsCartOpen(false)}
        cart={cart}
        onUpdateQuantity={updateQuantity}
        onRemoveItem={removeFromCart}
        onCheckout={handleCheckoutClick}
        deliveryCity={deliveryCity}
        onDeliveryCityChange={handleDeliveryCityChange}
        paymentMethod={paymentMethod}
        onPaymentMethodChange={handlePaymentMethodChange}
        appliedPromo={appliedPromo}
        onApplyPromo={handleApplyPromo}
        onRemovePromo={handleRemovePromo}
      />

      <ConfirmationModal
        isOpen={showConfirmation}
        onConfirm={handleConfirmOrder}
        onCancel={() => setShowConfirmation(false)}
        cart={cart}
        deliveryCity={deliveryCity}
        total={total}
        paymentMethod={paymentMethod}
        discount={discount}
        subtotal={subtotal}
        deliveryPrice={deliveryPrice}
      />

      <ContactModal
        isOpen={isContactOpen}
        onClose={() => setIsContactOpen(false)}
      />

      <ProductDetailModal
        product={selectedProduct}
        onClose={() => setSelectedProduct(null)}
        onAddToCart={addToCart}
        openViewer={openViewer}
      />

      <FullscreenViewer
        isOpen={viewerOpen}
        product={viewerProduct}
        startIndex={viewerStartIndex}
        onClose={closeViewer}
      />

      <Notification
        message={notification.message}
        isVisible={notification.isVisible}
        type={notification.type}
      />
      
      <Confetti trigger={confettiTrigger} />
    </div>
  );
};

ReactDOM.render(<App />, document.getElementById('root'));
</script>
<script data-goatcounter="https://tangerine1890.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>
